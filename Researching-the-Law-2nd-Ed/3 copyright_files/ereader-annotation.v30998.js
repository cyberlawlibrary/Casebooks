var highLightTextId,selectedNoteId,yValue,currentSectionIndex,dppAnotationId,noteSpanCreate,highLightColor,currentSectionId,currentSectionTitle,highlightStartOffset,highlightEndOffset,highlightedTextWithoutHTML,selectedHighlightColor,activeHeaderTab,annotationSectionId,annotationSectionTitle,alertMessageContent,sectionIdOfAssessementElement,ereaderAssessmentSectionId,sectionIdInsideBookTextAnnotation,ereaderAssessmentQuestionList,ereaderAssessmentQuestionType,ereaderAnnotationDisplay,bookIdWithClassCode,classDetailName,classDetailSem,classDetailSectionData,classDetailMeetingData,classDetailDescData,classDetailClassCode,thumbnailimagepath,classDetailCreatedDate,classDetailCreatedBy,classDetailBookId,leftPositionOfPopover,annotationStartParaId,annotationEndParaId,highlightStartOffsetAtSectionLevel,highlightEndOffsetAtSectionLevel,highlightedTextWithoutHTMLAtSectionLevel,multiParaAnnotationStartParaStartOffset,multiParaAnnotationStartParaEndOffset,highlightTagFirstPart,multiParaAnnotationID,highlightTagLastPart,linkTagLastPart,suggestRequest,currentPageNumb,touchStartXValue,redirectingFromSearchBySection=!1,sectionIdToBeRedirected=null,keepPopoverVisible=!1,highLightSpanId=0,addingNote=!1,updatingNote=!1,notesAndHighlightListVisible=!1,highlightPopoverVisible=!1,insideEreader=!1,topOffset=0,fetchingAnnotationsForListing=!1,annotationListingChapterId=null,bookChapterList=null,bookChapterSupplimentList=null,saveNoteConfirmationChecked=!1,savePopoverVisibleCount=0,clickedAnnotationIdFromListing=null,loadingNewChapterFromAnnotationListing=!1,searchResultListVisible=!1,comingFromTOC=!1,touchDevicesDragStarted=!1,saveActivityTimer=null,saveNoteTimer=null,currentFontId="textsize-default",insideOutline=!1,topOfEreaderScroller=!1,bottomOfEreaderScroller=!1,makingSpaceForpopoverToBeDisplayed=!1,currentlearningObjectId=null,currentQuestionId=null,noteTextClick=!1,questionIdAttemptedInRhythmOfContent=[],questionAlreadyAttempted=!1,alertMessageModalAppears=!1,loadingAnnotationsFromTOC=!0,autoSuggestRequest=null,currentSelectedAutoSuggestIndex=null,lastViewedSearchEreader="searchBySection",searchInputTextboxIsEmpty=!1,searchChapterId=null,searchedTextSaved=null,alreadyCalled=!1,pasteEnableFromClipboard=!1,ereaderAnnotationDisplayCount=0,selectedContent="",bookHavingClassAssociated=!1,insideGetClassDetails=!1,classInsightsRefresh=!1,indexedHighlight=!1,selectedParaIds=[],paraLevelAnnotation=!1,acrossParaLevelAnnotationFlag=!1,highLightSpanIdAcrossPara=[],multiParaHighlightIndexer=0,MARK=!1,enclosingParaIdString="",highLightedTextClickFlag=!1,gotoPageFnCald=!1,bookAnnotateFileList=null,selectionEndTimeout=null,listOfChapterAnnotation="",touchStartTimer=null,userTouchTimerEnded=!1,longTapDetected=!1,touchEndEventFound=!1,enableAnnotationForTouchDevices=!1,deleteNoteOnColorChange=!1,numberToCharacterMap={1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",9:"i",10:"j",11:"k",12:"l",13:"m",14:"n",15:"o",16:"p",17:"q",18:"r",19:"s",20:"t",21:"u",22:"v",23:"w",24:"x",25:"y",26:"z"},lostTextVal="",highlightPaletteOnly=!1,comingFromAnnotationPrevNextBtn=!1;function userSelectionChanged(){longTapDetected=!1,selectionEndTimeout&&clearTimeout(selectionEndTimeout),selectionEndTimeout=setTimeout(function(){$(window).trigger("selectionEnd")},1200)}function userTouchStarted(e){touchStartTimer&&clearTimeout(touchStartTimer),userTouchTimerEnded=!1,longTapDetected=!1,touchStartTimer=setTimeout(function(){userTouchTimerEnded=!0},1200)}function userTouchEnded(e){if(touchEndEventFound=!0,userTouchTimerEnded)longTapDetected=!0;else if(!navigator.userAgent.match(/(Android|iPhone)/)){var t=$('highlight[id^="note"]');if(t&&!addingBrief){addingNote=!1,updatingNote=!1,addingLink=!1,addingBrief=!1,updatingLink=!1,updatingBrief=!1,$("#"+selectedNoteId).popover("hide");for(var a=0;a<t.length;a++){var n=document.getElementById(t[a].id),i=document.createElement("span");i.innerHTML=n.innerHTML,i.normalize(),n.parentNode.replaceChild(i,n)}}}}function addEventListenerForIpadandAndroid(){document.onselectionchange=userSelectionChanged,null!==document.getElementById("tab-section-container")&&(document.getElementById("tab-section-container").ontouchstart=userTouchStarted,document.getElementById("tab-section-container").ontouchend=userTouchEnded),null!==document.getElementById("case-excerpt-block-cases")&&(document.getElementById("case-excerpt-block-cases").ontouchstart=userTouchStarted,document.getElementById("case-excerpt-block-cases").ontouchend=userTouchEnded),document.getElementById("add-note-textarea").ontouchstart=noteTextTouchStarted,document.getElementById("add-brief-textarea").ontouchstart=noteTextTouchStarted}function highLightSelection(e){if($("#note-save-confirmation-wrapper").remove(),insideEreader||insideCasesPage){var t;if(insideTouchDevices||(insideTouchDevices=!1),e&&$('[data-toggle="popover"]').each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(this).hasClass("highlightedText")||$(e.target).hasClass("highlightedText")||$(this).hasClass("anchorElementText")||$(e.target).hasClass("anchorElementText")||$(this).hasClass("briefElementText")||$(e.target).hasClass("briefElementText")||$(this).hasClass("rTsIconPopover")||addingNote||updatingNote||addingLink||updatingLink||addingBrief||updatingBrief||insideTouchDevices||($(this).popover("hide"),insideEreader&&$(document).popover("hide"))}),window.getSelection?t=window.getSelection():void 0!==document.selection&&(t=document.selection),selectedContent=t.toString(),t.toString().length>0)if("true"===CaseConnect.bookData.isAnnotatable||insideCasesPage){if(""===t.toString())return!0;var a=t.getRangeAt(0),n=getSelectionHtml(),i=$('highlight[id^="note"]');if(i){addingNote=!1,updatingNote=!1,addingLink=!1,addingBrief=!1,updatingLink=!1,updatingBrief=!1,$("#"+selectedNoteId).popover("hide");for(var o=0;o<i.length;o++){var r=document.getElementById(i[o].id),s=document.createElement("span");s.innerHTML=r.innerHTML,s.normalize(),r.parentNode.replaceChild(s,r)}}var l=!1;if(-1!==n.indexOf("</p>")){var d=$(n);for(o=0;o<d.length;o++){var h=d[o];if("div"===h.nodeName.toLowerCase()&&"cc-section"===h.getAttribute("class")){l=!0;break}}}if(l||checkForTable(n)||-1!==n.indexOf("cc-section")||-1!==n.indexOf("highlightedText")||-1!==n.indexOf("anchorElementText")||-1!==n.indexOf("briefElementText")||-1!==n.indexOf("</td>")||addingNote||updatingNote||addingLink||updatingLink||addingBrief||updatingBrief)-1!==n.indexOf("highlightedText")?alertMessagesModal(exceptionMsg.existingHightlight):-1!==n.indexOf("cc-section")&&alertMessagesModal(exceptionMsg.existingSection),-1!==n.indexOf("briefElementText")?alertMessagesModal(exceptionMsg.existingAnnotation):-1!==n.indexOf("anchortag")?alertMessagesModal(exceptionMsg.existingAnnotation):checkForTable(n)?alertMessagesModal(exceptionMsg.existingTable):-1!==n.indexOf("cc-section")?alertMessagesModal(exceptionMsg.existingSection):addingNote||updatingNote||addingLink||updatingLink;else if(t.anchorOffset!==t.focusOffset){for(var g=t.focusNode,c=g,p=g,u=g;!$(c).hasClass("cc-principal-case");)if(null!=(c=c.parentNode))insidePrincipalCase=!0;else if(null==c){insidePrincipalCase=!1;break}if(insidePrincipalCase){if(-1!==n.indexOf("cc-principalCase-title")&&-1!==n.indexOf("epub-text-para"))return void alertMessagesModal("Please highlight either the section heading or the section text, not both.");if(-1!==n.indexOf("cc-principal-case-citation")&&-1!==n.indexOf("epub-text-para"))return void alertMessagesModal("Please highlight either the section heading or the section text, not both.");for(;!$(p).hasClass("epub-law-heading-container");)if(null!=(p=p.parentNode))pCaseWithHeadingCitation=!0;else if(null==p){pCaseWithHeadingCitation=!1;break}for(;!$(u).hasClass("cc-principalCase-title");)if(null!=(u=u.parentNode))pCaseWithHeadingOnly=!0;else if(null==u){pCaseWithHeadingOnly=!1;break}}for(var f=g;!$(f).hasClass("cc-wrapper");)f=f.parentNode;if(annotationEndParaId=f.id,insidePrincipalCase)if(pCaseWithHeadingCitation)for(;!($(g).hasClass("highlightedText")||$(g).hasClass("anchorElementText")||null!==(g=g.parentNode)&&$(g.parentNode).hasClass("content-holder-block")););else for(;!($(g).hasClass("briefElementText")||$(g).hasClass("anchorElementText")||null!==(g=g.parentNode)&&$(g.parentNode).hasClass("content-holder-block")););else for(;!($(g).hasClass("highlightedText")||$(g).hasClass("anchorElementText")||null!==(g=g.parentNode)&&$(g.parentNode).hasClass("content-holder-block")););if(updatingLink)for(;!($(g).hasClass("anchorElementText")||null!==(g=g.parentNode)&&$(g.parentNode).hasClass("content-holder-block")););if(updatingBrief)for(;!($(g).hasClass("briefElementText")||null!==(g=g.parentNode)&&$(g.parentNode).hasClass("content-holder-block")););for(var m=t.anchorNode,I=m;!$(I).hasClass("cc-wrapper");)I=I.parentNode;if(annotationStartParaId=I.id,insidePrincipalCase)if(pCaseWithHeadingCitation)for(;!($(m).hasClass("highlightedText")||$(g).hasClass("anchorElementText")||null!==(m=m.parentNode)&&$(m.parentNode).hasClass("content-holder-block")););else for(;!($(m).hasClass("briefElementText")||$(g).hasClass("anchorElementText")||null!==(m=m.parentNode)&&$(m.parentNode).hasClass("content-holder-block")););else for(;!($(m).hasClass("highlightedText")||$(g).hasClass("anchorElementText")||null!==(m=m.parentNode)&&$(m.parentNode).hasClass("content-holder-block")););if(updatingLink)for(;!($(m).hasClass("anchorElementText")||null!==(m=m.parentNode)&&$(m.parentNode).hasClass("content-holder-block")););if(updatingBrief)for(;!($(m).hasClass("briefElementText")||null!==(m=m.parentNode)&&$(m.parentNode).hasClass("content-holder-block")););if(!($(m).hasClass("highlightedText")||$(g).hasClass("highlightedText")||$(m).hasClass("briefElementText")||$(g).hasClass("briefElementText")||$(m).hasClass("anchorElementText")||$(g).hasClass("anchorElementText"))){highLightSpanId=0,highLightSpanIdAcrossPara=[],selectedParaIds=[];var C,v={},P={},T={},S={},O={},b={},N={},L={},A={},x=!1;paraLevelAnnotation=!1,acrossParaLevelAnnotationFlag=annotationStartParaId!==annotationEndParaId,C=a.extractContents();for(var E=0;E<C.childNodes.length;E++)if($(C.childNodes[E]).hasClass("cc-wrapper")&&(paraLevelAnnotation=!0,-1==jQuery.inArray(C.childNodes[E].id,selectedParaIds)&&(selectedParaIds.push(C.childNodes[E].id),v[C.childNodes[E].id]=C.childNodes[E].textContent,P[C.childNodes[E].id]=C.childNodes[E].innerHTML,T[C.childNodes[E].id]=C.childNodes[E].outerHTML)),!$(C.childNodes[E]).hasClass("cc-wrapper")&&C.childNodes[E].hasChildNodes()){var y=document.createElement(C.childNodes[E].tagName.toLowerCase());y.setAttribute("class",C.childNodes[E].className),getAllSelectedParaDetails(C.childNodes[E],selectedParaIds,v,P,T,S,y,O,b,A,N,L)}if(enclosingParaIdString="",selectedParaIds.length>0)for(var k=0;k<selectedParaIds.length;k++){var M=k===selectedParaIds.length-1?"":"|";enclosingParaIdString+=selectedParaIds[k]+M}if(enclosingParaIdString="",selectedParaIds.length>0)for(k=0;k<selectedParaIds.length;k++){M=k===selectedParaIds.length-1?"":"|";enclosingParaIdString+=selectedParaIds[k]+M}var H=document.createElement("highlight");if(H.id="note"+highLightSpanId,H.setAttribute("data-references","popover"),H.setAttribute("data-toggle","popover"),H.setAttribute("class","highlightedText"),H.setAttribute("tabindex","0"),H.setAttribute("enclosingParaIdString",enclosingParaIdString),H.setAttribute("highlightStartParaId",annotationStartParaId),H.setAttribute("highlightEndParaId",annotationEndParaId),H.appendChild(C),highlightedTextWithoutHTML="",annotationStartParaId!==annotationEndParaId){if(selectedParaIds.length>0){for(k=0;k<selectedParaIds.length;k++){var w=document.createElement("highlight");if(w.id="note"+k,w.setAttribute("data-references","popover"),w.setAttribute("data-toggle","popover"),w.setAttribute("class","highlightedText"),w.setAttribute("tabindex","0"),w.setAttribute("aria-label",P[selectedParaIds[k]]),w.setAttribute("enclosingParaIdString",enclosingParaIdString),w.setAttribute("highlightStartParaId",annotationStartParaId),w.setAttribute("highlightEndParaId",annotationEndParaId),w.innerHTML=P[selectedParaIds[k]],highLightSpanIdAcrossPara.push(k),-1===convertStringTOHTMLObject(T[selectedParaIds[k]]).className.indexOf("cc-pagenum-begin")){var B=convertStringTOHTMLObject(T[selectedParaIds[k]]);if($(B).find(".cc-pagenum-begin").length>0)for(var R=v[selectedParaIds[k]],V=0;V<$(B).find(".cc-pagenum-begin").length;V++){var F=$(B).find(".cc-pagenum-begin")[V];highlightedTextWithoutHTML+=R.replace(F.textContent,"")}else highlightedTextWithoutHTML+=v[selectedParaIds[k]]}if(0===k){je=(je=(je=(je=document.getElementById(selectedParaIds[k]).textContent).replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "),highlightStartOffset=je.length,document.getElementById(selectedParaIds[k]).innerHTML=document.getElementById(selectedParaIds[k]).innerHTML+w.outerHTML;var D=document.getElementById(selectedParaIds[k]);setTimeout(function(){for(var e=0;e<D.childNodes.length;e++)"highlightedText"===D.childNodes[e].className&&-1===D.childNodes[e].id.indexOf("note")&&(document.getElementById(D.childNodes[e].id).setAttribute("onClick","highLightedTextClick()"),document.getElementById(D.childNodes[e].id).addEventListener("keyup",highLightedTextOnEnter))},500)}else{var _=w.textContent,W=(_=(_=(_=_.replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," ")).trim();if(highlightEndOffset=_.length,-1!==_.indexOf(W)&&(highlightEndOffset-=_.indexOf(W)),null!==document.getElementById(selectedParaIds[k])){document.getElementById(selectedParaIds[k]).innerHTML=w.outerHTML+document.getElementById(selectedParaIds[k]).innerHTML;D=document.getElementById(selectedParaIds[k]);var j=document.getElementById(selectedParaIds[k]);if(void 0!==b[selectedParaIds[k]])for(;null!==j&&void 0!==j.tagName&&!(j.tagName.toLowerCase().indexOf("ul")>=0||j.tagName.toLowerCase().indexOf("ol")>=0);)j=j.parentNode;if(setTimeout(function(){for(var e=0;e<D.childNodes.length;e++)"highlightedText"===D.childNodes[e].className&&-1===D.childNodes[e].id.indexOf("note")&&(document.getElementById(D.childNodes[e].id).setAttribute("onClick","highLightedTextClick()"),document.getElementById(D.childNodes[e].id).addEventListener("keyup",highLightedTextOnEnter))},500),void 0!==N[selectedParaIds[k]]&&void 0!==b[selectedParaIds[k]]&&b[selectedParaIds[k]]===b[selectedParaIds[k-1]]&&S[selectedParaIds[k]]==S[selectedParaIds[k]]){for(var U,J=1;J<selectedParaIds.length;J++){if(null!==document.getElementById(selectedParaIds[k-J]))if(document.getElementById(selectedParaIds[k-J]).className.indexOf("cc-wrapper")>=0){U=document.getElementById(selectedParaIds[k-J]);break}}var K=$(D.parentNode).find(".cc-wrapper");$(D.parentNode).remove(),$(U).after(K)}else if(void 0!==b[selectedParaIds[k]]&&null!==b[selectedParaIds[k]]&&b[selectedParaIds[k]].length>0&&b[selectedParaIds[k]][0].id!==selectedParaIds[k]){convertStringTOHTMLObject(S[selectedParaIds[k]]).children[0],document.getElementById(selectedParaIds[k]);for(var q=document.getElementById(selectedParaIds[k]);-1===q.tagName.toLowerCase().indexOf("li");)q=q.parentNode;var z,G=q.innerHTML;q.remove();for(J=1;J<selectedParaIds.length;J++)if(null!==document.getElementById(selectedParaIds[k-J])){z=document.getElementById(selectedParaIds[k-J]);break}if(S[z.id]===S[selectedParaIds[k]]){(ee=document.createElement("li")).innerHTML=G;var Q=[];Q.push(ee);for(var X=$(j).find("li"),Y=0;Y<X.length;Y++)Q.push(X[Y]);for(;-1===z.tagName.toLowerCase().indexOf("li");)z=z.parentNode;for(;"li"!==j.tagName.toLowerCase()&&!(j.className.indexOf("cc-section")>=0);)j=j.parentNode;if($(j).remove(),$(z).after(Q),z.parentNode.tagName.toLowerCase().indexOf("ul")>=0||z.parentNode.tagName.toLowerCase().indexOf("ol")>=0)if(z.parentNode.parentNode.tagName.toLowerCase().indexOf("ul")>=0||z.parentNode.parentNode.tagName.toLowerCase().indexOf("ol")>=0)null!==(Z=z.parentNode.previousSibling)&&$(Z.previousSibling).find(".cc-wrapper")===b[selectedParaIds[k]]&&(Z.innerHTML=Z.innerHTML+z.parentNode.outerHTML,$(z.parentNode).remove());else if(null===z.parentNode.previousElementSibling&&z.parentNode.parentNode.tagName.toLowerCase().indexOf("li")>=0){var Z;null!==(Z=z.parentNode.parentNode).previousSibling&&$(Z.previousSibling).find(".cc-wrapper")===b[selectedParaIds[k]]&&(Z.previousSibling.innerHTML=Z.previousSibling.innerHTML+z.parentNode.parentNode.innerHTML,$(z.parentNode.parentNode).remove())}}else{var ee;(ee=document.createElement("ul")).innerHTML=S[z.id],$(ee).find("li");for(var te=$(ee).find("li"),ae=0;ae<te.length;ae++){for(;-1===z.tagName.toLowerCase().indexOf("li");)z=z.parentNode;ae!==te.length-1&&(z=z.parentNode)}(ge=document.createElement("li")).innerHTML=G,$(z).after(ge)}}else if(selectedParaIds[k]in A){for(var ne=0,ie=1;ie<selectedParaIds.length;ie++){if(null!=document.getElementById(selectedParaIds[k-ie]))if(document.getElementById(selectedParaIds[k-ie]).className.indexOf("cc-wrapper")>=0){ne=ie;break}}if(S[selectedParaIds[k-ne]].indexOf("epub-feature")>=0){for(;-1===j.className.indexOf("epub-feature");)j=j.parentNode;var oe=[];$.each(A,function(e,t){oe.push(e)});var re=document.getElementById(oe[0]);for(re.className.indexOf("epub-feature-heading2")>=0&&(re=re.parentNode);-1===re.className.indexOf("epub-feature");)(re=re.parentNode).className.indexOf("epub-feature-heading2")>=0&&(re=re.parentNode);re.innerHTML=re.innerHTML+j.innerHTML,$(j).remove()}}}else{var se,le=document.getElementById(selectedParaIds[k-1]);if(void 0!==S[selectedParaIds[k]]){var de=document.createElement("div");de.innerHTML=S[selectedParaIds[k]],se=de.children[0]}var he=document.createElement($(T[selectedParaIds[k]]).prop("tagName").toLowerCase());if(he.id=selectedParaIds[k],he.setAttribute("class",$(T[selectedParaIds[k]]).attr("class")),he.innerHTML=w.outerHTML,void 0===se||"ol"!==se.tagName.toLowerCase()&&"ul"!==se.tagName.toLowerCase()||null===le||(null!==le.nextElementSibling?le.nextElementSibling.tagName.toLowerCase()===se.tagName.toLowerCase():"li"===le.parentNode.tagName.toLowerCase()))if(void 0!==S[selectedParaIds[k]]){var ge=document.createElement("li");if("ol"===se.tagName.toLowerCase()||"ul"===se.tagName.toLowerCase()){var ce=b[selectedParaIds[k]];if(null!=ce&&ce.length>0&&ce[0].id!==selectedParaIds[k]){x=!0;var pe=document.createElement("div");pe.innerHTML=se.children[0].innerHTML,setInnerHTML(se=pe.children[0],he)}else he.className.indexOf("cc-pagenum-begin")>=0?se=he:(ge.innerHTML=se.children[0].innerHTML,setInnerHTML(ge,he),setInnerHTML(se,he))}else{if(se.innerHTML.length>0)if(null!==se.children&&void 0!==se.children)se.children.length>0&&(he.className.indexOf("cc-pagenum-begin")>=0?se=he:setInnerHTML(se,he));else se.innerHTML=se.innerHTML+he.outerHTML;else he.className.indexOf("cc-pagenum-begin")>=0?se=he:se.innerHTML=he.outerHTML}if(null===le||null===le.nextElementSibling||"ol"!==se.tagName.toLowerCase()&&"ul"!==se.tagName.toLowerCase()||"li"!==le.nextElementSibling.tagName.toLowerCase()&&"ol"!==le.nextElementSibling.tagName.toLowerCase())if(void 0!==S[selectedParaIds[k-1]]&&void 0===S[selectedParaIds[k]]){var ue=document.getElementById(selectedParaIds[k-1]);$(ue.parentNode).after(se)}else{var fe=le.parentNode;for(ne=0,ie=1;ie<selectedParaIds.length;ie++){if(null!=document.getElementById(selectedParaIds[k-ie]))if(document.getElementById(selectedParaIds[k-ie]).className.indexOf("cc-wrapper")>=0){ne=ie;break}}if(se.className.indexOf("cc-pagenum-begin")>=0)$(le).after(se);else if(S[selectedParaIds[k]]===S[selectedParaIds[k-ne]]&&void 0!==b[selectedParaIds[k]]&&b[selectedParaIds[k-ne]]===b[selectedParaIds[k]]){for(var me=le;"li"!==me.tagName.toLowerCase();)me=me.parentNode;for(;-1===se.className.indexOf("cc-wrapper");)se=se.children[0];if(O[selectedParaIds[k-ne]]===O[selectedParaIds[k]])(ge=document.createElement("li")).innerHTML=se.outerHTML,void 0!==N[selectedParaIds[k]]?me.innerHTML=me.innerHTML+se.outerHTML:$(me).after(ge);else $(le).after(se)}else if(void 0===S[selectedParaIds[k-ne]]&&void 0!==S[selectedParaIds[k]])$("#"+selectedParaIds[k-ne]).after(se);else if(null!==fe)if(null!==fe.nextElementSibling&&"li"===fe.tagName.toLowerCase()&&"li"===fe.nextElementSibling.tagName.toLowerCase()){var Ie=[];if(selectedParaIds[k]in A)if($.each(A,function(e,t){Ie.push(e)}),null===document.getElementById(Ie[0])&&null===document.getElementById(Ie[Ie.length-1]))if(selectedParaIds[k]in b&&b[selectedParaIds[k-1]]===b[selectedParaIds[k]]){for(var Ce=!1,ve=0;ve<b[selectedParaIds[k]].length;ve++)if(b[selectedParaIds[k]][ve].id===A[selectedParaIds[k]][0].id){Ce=!0;break}if(Ce){for(var Pe=se;-1===Pe.className.indexOf("epub-feature");)Pe=Pe.children[0];$(le).after(Pe)}else le.innerHTML=le.innerHTML+se.children[0].outerHTML}else $(le).after(se.outerHTML);else{for(var Te=0;Te<selectedParaIds.length;Te++)selectedParaIds[Te]in A&&null!==document.getElementById(selectedParaIds[Te])&&(xe=document.getElementById(selectedParaIds[Te]));if(null!==xe){for(Pe=se;-1===Pe.className.indexOf("epub-feature");)Pe=Pe.children[0];if(xe.id===Ie[Ie.length-1])if(void 0!==S[Pe.children[0].id]&&-1===S[Pe.children[0].id].indexOf("li")&&S[xe.id].indexOf("li")>0){for(;!(xe.tagName.toLowerCase().indexOf("ol")>=0||xe.tagName.toLowerCase().indexOf("ul")>=0);)xe=xe.parentNode;$(Pe.children[0]).insertBefore(xe)}else if(S[$(Pe).find(".cc-wrapper").attr("id")]===S[xe.id]&&void 0!==b[xe.id]&&void 0!==b[$(Pe).find(".cc-wrapper").attr("id")]){for(;-1===xe.tagName.toLowerCase().indexOf("li");)xe=xe.parentNode;$($(Pe).find("li")).insertBefore(xe)}else $(Pe.children[0]).insertBefore(xe);else $(xe).after(Pe.children[0])}}else if(selectedParaIds[k]in b&&b[selectedParaIds[k-1]]===b[selectedParaIds[k]]&&S[selectedParaIds[k]]===S[selectedParaIds[k-ne]])fe.innerHTML=fe.innerHTML+se.children[0].outerHTML;else{var Se=$(fe).find("ul");0!==Se.length?0===$(Se).find("p#"+selectedParaIds[k-1]).length&&$(Se).prepend(se.children[0]):x?fe.innerHTML=fe.innerHTML+se.outerHTML:"ul"!==se.tagName.toLowerCase()&&"ol"!==se.tagName.toLowerCase()||S[selectedParaIds[k]]!==S[selectedParaIds[k-ne]]?b[selectedParaIds[k]][0].id===selectedParaIds[k-1]?fe.innerHTML=fe.innerHTML+se.innerHTML:$(fe).after(se):$(fe).after(se.children[0])}}else if("li"===fe.tagName.toLowerCase())if(x)if(S[selectedParaIds[k]]===S[selectedParaIds[k-1]])fe.innerHTML=fe.innerHTML+se.outerHTML;else{for(var Oe="",be=1;be<selectedParaIds.length;be++)if(S[selectedParaIds[k]]===S[selectedParaIds[k-be]]){Oe=selectedParaIds[k-be];break}var Ne=document.getElementById(Oe);if(null!==Ne&&b[selectedParaIds[k]]!==b[Ne.id])if(b[selectedParaIds[k]]===b[selectedParaIds[k-1]]){var Le=document.getElementById(selectedParaIds[k-1]);Le.parentNode.innerHTML=Le.parentNode.innerHTML+se.outerHTML}else $(Ne.parentNode).after(convertStringTOHTMLObject(se.innerHTML));else if(null===Ne)fe.innerHTML=fe.innerHTML+se.outerHTML;else if("li"===Ne.tagName.toLowerCase())Ne.parentNode.innerHTML=Ne.parentNode.innerHTML+se.innerHTML;else{for(;"li"!==Ne.tagName.toLowerCase()&&-1===Ne.className.indexOf("cc-section");)Ne=Ne.parentNode;Ne.parentNode.innerHTML=Ne.parentNode.innerHTML+se.innerHTML}}else if(he.className.indexOf("cc-pagenum-begin")>=0)fe.innerHTML=fe.innerHTML+se.outerHTML;else if(S[selectedParaIds[k-1]]===S[selectedParaIds[k]])$(fe).after($(se).find("li"));else{for(;null!==fe&&null===fe.nextElementSibling;)fe=fe.parentNode;$(fe).after(se)}else if(void 0===S[selectedParaIds[k-ne]])se.className.indexOf("epub-law-case")>=0&&$(se).attr("style","border-bottom: 0 none;"),$(le).after(se);else{se.className.indexOf("epub-law-case")>=0&&$(se).attr("style","border-bottom: 0 none;"),(ke=document.createElement("div")).innerHTML=S[selectedParaIds[k-ne]];for(var $e=ke.children[0],Ae=0;$e.children.length>0;)Ae++,$e=$e.children[0];for(ae=0;ae<Ae+1;ae++)le=le.parentNode;if(selectedParaIds[k]in A){var xe;for(Te=0;Te<selectedParaIds.length;Te++)selectedParaIds[Te]in A&&null!==document.getElementById(selectedParaIds[Te])&&(xe=document.getElementById(selectedParaIds[Te]));Ie=[];if(selectedParaIds[k]in A&&$.each(A,function(e,t){Ie.push(e)}),null!==xe){for(Pe=se;-1===Pe.className.indexOf("epub-feature");)Pe=Pe.children[0];if(xe.id===Ie[Ie.length-1])if(void 0!==S[Pe.children[0].id]&&-1===S[Pe.children[0].id].indexOf("li")&&S[xe.id].indexOf("li")>0){for(;!(xe.tagName.toLowerCase().indexOf("ol")>=0||xe.tagName.toLowerCase().indexOf("ul")>=0);)xe=xe.parentNode;$(Pe.children[0]).insertBefore(xe)}else if(S[$(Pe).find(".cc-wrapper").attr("id")]===S[xe.id]&&void 0!==b[xe.id]&&void 0!==b[$(Pe).find(".cc-wrapper").attr("id")]){for(;-1===xe.tagName.toLowerCase().indexOf("li");)xe=xe.parentNode;$($(Pe).find("li")).insertBefore(xe)}else $(Pe.children[0]).insertBefore(xe);else S[xe.id]===S[selectedParaIds[k]]?$(xe).after(Pe.children[0]):xe.parentNode.className.indexOf("epub-feature")>=0?xe.parentNode.className.indexOf("epub-feature-heading2")>=0?$(xe.parentNode).after(Pe.children[0]):$(xe).after(Pe.children[0]):$(xe.parentNode).after(Pe.children[0])}}else if(selectedParaIds[k]in b){for(var Ee=se;-1===Ee.tagName.toLowerCase().indexOf("li");)Ee=Ee.children[0];b[selectedParaIds[k]]===b[selectedParaIds[k-1]]?le.innerHTML=le.innerHTML+Ee.children[0].outerHTML:$(le).after(se)}else $(le).after(se)}}else le.nextElementSibling.innerHTML=ge.outerHTML+le.nextElementSibling.innerHTML}else if(void 0!==S[selectedParaIds[k-1]]&&void 0===S[selectedParaIds[k]]){ue=document.getElementById(selectedParaIds[k-1]);for(var ye=convertStringTOHTMLObject(S[selectedParaIds[k-1]]);ue.tagName.toLowerCase()!==ye.tagName.toLowerCase()&&null!==ye;)ue=ue.parentNode;$(ue).after(he)}else if(void 0===S[selectedParaIds[k-1]])$(le).after(he);else{var ke;(ke=document.createElement("div")).innerHTML=S[selectedParaIds[k-1]];for($e=ke.children[0],Ae=0;$e.children.length>0;)Ae++,$e=$e.children[0];for(ae=0;ae<Ae+1;ae++)le=le.parentNode;$(le).after(se)}else{var Me=document.createElement(se.tagName.toLowerCase());Me.setAttribute("class",se.className);var He=document.createElement("li");He.innerHTML=he.outerHTML,Me.innerHTML=He.outerHTML,$(le).after(Me)}}}}for(var we=0;we<selectedParaIds.length;we++)if(void 0!==L[selectedParaIds[we]]){$("#"+selectedParaIds[we]).after(L[selectedParaIds[we]]);break}}}else a.insertNode(H);annotationStartParaId===annotationEndParaId&&selectedParaIds.push(annotationStartParaId);for(var Be=$("highlight[id^=note]"),Re=0;Re<Be.length;Re++)Be[Re].parentNode.className.indexOf("cc-pagenum-begin")>=0&&(Be[Re].parentNode.innerHTML=Be[Re].innerHTML);for(var Ve=document.getElementById("note"+highLightSpanId),Fe=Ve.parentNode;!$(Fe).hasClass("cc-section")&&Fe.parentNode;)Fe=Fe.parentNode;annotationSectionId=null!==Fe&&$(Fe).hasClass("cc-section")?Fe.id:"";var De="";$(Fe).hasClass("cc-section")?(annotationSectionTitle=Fe.getElementsByClassName("cc-section-title").length>0?removeTags(Fe.getElementsByClassName("cc-section-title")[0].innerHTML):Fe.getElementsByClassName("cc-principalCase-title").length>0?removeTags(Fe.getElementsByClassName("cc-principalCase-title")[0].innerHTML):"",De=Fe.outerHTML):annotationSectionTitle="";var _e=document.getElementById(annotationStartParaId).outerHTML,We=Ve.outerHTML;if(annotationStartParaId===annotationEndParaId){var je;je=(je=(je=(je=removeTags(_e.split(We)[0])).replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "),highlightStartOffset=je.length;var Ue,Je,Ke=document.getElementById("note"+highLightSpanId),qe=Ke.innerHTML,ze=Ke.getElementsByTagName("span").length;for(E=0;E<ze;E++){(at=document.getElementById("note"+highLightSpanId).getElementsByTagName("span")[E]).hasAttribute("id")&&(Je=(Ue=at.innerHTML).length)}if(qe=(qe=(qe=qe.replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "),Ue){qe=qe.replace(Ue,"");var Ge=(highlightedTextWithoutHTML=removeTags(qe)).length;highlightEndOffset=highlightStartOffset+Ge+Je}else{Ge=(highlightedTextWithoutHTML=removeTags(qe)).length;highlightEndOffset=highlightStartOffset+Ge}idToBeReplaced="note"+highLightSpanId,setTimeout(function(){showHighLightPopoverAfterHighLight(idToBeReplaced)},50)}else idToBeReplaced="note"+highLightSpanId,setTimeout(function(){showHighLightPopoverAfterHighLight(idToBeReplaced)},50);var Qe=removeTags(De.split(We)[0]);Qe=(Qe=(Qe=Qe.replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "),highlightStartOffsetAtSectionLevel=Qe.length,linkStartOffset=Qe.length,briefStartOffsetAtSectionLevel=Qe.length;var Xe,Ye,Ze=document.getElementById("note"+highLightSpanId),et=Ze.innerHTML,tt=Ze.getElementsByTagName("span").length;for(E=0;E<tt;E++){var at;(at=document.getElementById("note"+highLightSpanId).getElementsByTagName("span")[E]).hasAttribute("id")&&(Ye=(Xe=at.innerHTML).length)}if(et=(et=(et=et.replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "),Xe){et=et.replace(Xe,"");var nt=(highlightedTextWithoutHTMLAtSectionLevel=removeTags(et)).length;highlightEndOffsetAtSectionLevel=highlightStartOffsetAtSectionLevel+nt+Ye,briefEndOffsetAtSectionLevel=highlightEndOffsetAtSectionLevel}else{nt=(highlightedTextWithoutHTMLAtSectionLevel=removeTags(et)).length;highlightEndOffsetAtSectionLevel=highlightStartOffsetAtSectionLevel+nt,briefEndOffsetAtSectionLevel=highlightEndOffsetAtSectionLevel}linkEndOffset=highlightEndOffsetAtSectionLevel}}}else alertMessagesModal(exceptionMsg.highlightChapters);else if(""===t.toString())return!0;setTimeout(function(){window.getSelection().removeAllRanges()},50)}}function setInnerHTML(e,t){return e.children.length>0?setInnerHTML(e.children[0],t):e.innerHTML=t.outerHTML,e}function setStringToInnerHTML(e,t){return e.children.length>0?setInnerHTML(e.children[0],t):e.innerHTML=t,e}function getWrapperContent(e){for(var t=0;t<e.childNodes.length;t++)e.childNodes[t].className.indexOf("epubWrapper")&&e.removeChild(e.childNodes[t]);return e}function getAllSelectedParaDetails(e,t,a,n,i,o,r,s,l,d,h,g){if(null!=e){var c=r;if(null!==e.id&&e.id.length>0&&e.className.indexOf("cc-wrapper")>=0)-1==jQuery.inArray(e.id,t)&&(t.push(e.id),a[e.id]=e.textContent,n[e.id]=e.innerHTML,i[e.id]=e.outerHTML,o[e.id]=c.outerHTML,s[e.id]=c.outerHTML,null!==l[e.id]&&null!==e.previousElementSibling&&void 0!==e.previousElementSibling.tagName&&"li"!==e.previousElementSibling.tagName.toLowerCase()&&(h[e.id]=c.outerHTML));else if(e.hasChildNodes()){e.className.indexOf("cc-pagenum-begin")>=0&&(g[t[t.length-1]]=e);for(var p=0;p<e.children.length;p++){if(e.tagName.toLowerCase().indexOf("li")>=0)for(var u=$(e).find(".cc-wrapper"),f=0;f<u.length;f++)u[f].id in l||(l[u[f].id]=u);if(e.className.indexOf("epub-feature")>=0)for(u=$(e).find(".cc-wrapper"),f=0;f<u.length;f++)u[f].id in d||(d[u[f].id]=u);if(void 0!==e.children[p].className&&e.children[p].className.length>0&&e.children[p].className.indexOf("cc-wrapper")>=0)if(null!==e.children[p].parentNode&&void 0!==e.children[p].parentNode){var m=e.children[p].parentNode,I=document.createElement(e.children[p].parentNode.tagName);for(I.setAttribute("class",e.className);void 0!==m.parentNode.className;){var C=document.createElement(m.parentNode.tagName);C.setAttribute("class",m.parentNode.className),C.innerHTML=I.outerHTML,I=C,m=m.parentNode}c=I}else c=r;else{var v=c.children.length,P=document.createElement(e.children[p].tagName.toLowerCase());P.setAttribute("class",e.className),null!==v&&v>0?c=setInnerHTML(c,P):c.innerHTML=P.outerHTML}e.children[p].className.indexOf("cc-pagenum-begin")>=0&&(g[t[t.length-1]]=e.children[p]),getAllSelectedParaDetails(e.children[p],t,a,n,i,o,c,s,l,d,h,g)}}}}function getnextElementSibling(e){var t=e.parentNode;if(null!==t.nextElementSibling)return t;getnextElementSibling(t)}function getSelectionHtml(){var e="";if(void 0!==window.getSelection){var t=window.getSelection();if(t.rangeCount){for(var a=document.createElement("div"),n=0,i=t.rangeCount;n<i;++n)a.appendChild(t.getRangeAt(n).cloneContents());e=a.innerHTML}}else void 0!==document.selection&&"Text"==document.selection.type&&(e=document.selection.createRange().htmlText);return e}function checkForTable(e){return e.indexOf("</th>")>=0||e.indexOf("</td>")>=0||e.indexOf("</tr>")>=0||e.indexOf("</tbody>")>=0||e.indexOf("</table>")>=0}function convertStringTOHTMLObject(e){var t=document.createElement("DIV");return t.innerHTML=e,t.children[0]}function removeTags(e){var t=document.createElement("DIV");return t.innerHTML=e,t.textContent}function noteTextTouchStarted(e){"Android"===CaseConnect.deviceOS&&"Chrome"===CaseConnect.browserName&&(document.querySelector('meta[name="viewport"]').content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1")}function saveHighlights(){if(checkSaveHighlight){if(!highlightPalletsVisibleOnly&&navigator.userAgent.match(/(iPad|Android|iPhone)/)&&(lostTextVal=$("textarea#add-note-textarea")[1],highlightPaletteOnly=!1),saveHighlightsRequestData=highlightStartOffsetAtSectionLevel+"_"+highlightEndOffsetAtSectionLevel+"_"+annotationStartParaId+"_"+annotationEndParaId+"_"+highlightStartOffset+"_"+highlightEndOffset,void 0!==localStorage.getItem("annotationListForChapter")&&null!==localStorage.getItem("annotationListForChapter")){for(var e=localStorage.getItem("annotationListForChapter").split(","),t=0;t<e.length;t++)if(e[t]===saveHighlightsRequestData)return highlightPalletsVisibleOnly=!1,void $("#"+selectedNoteId).popover("hide");allExistingAnnotationUniqueVal.push(saveHighlightsRequestData),localStorage.setItem("annotationListForChapter",allExistingAnnotationUniqueVal)}$("#page-loading-spinner").show();var a={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_ADD_HIGHLIGHT",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,sectionId:annotationSectionId,sectionTitle:annotationSectionTitle,pageNumber:CaseConnect.currentPageNumber,highlightStartOffset:highlightStartOffsetAtSectionLevel,highlightEndOffset:highlightEndOffsetAtSectionLevel,highlightText:highlightedTextWithoutHTML,highlightStartParaId:annotationStartParaId,highlightEndParaId:annotationEndParaId,highlightParaStartOffset:highlightStartOffset,highlightParaEndOffset:highlightEndOffset,enclosingParaList:selectedParaIds,highlightColorCode:highLightColor}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/addChapterHighlights",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(a)}).then(function(e){void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),e.annotationVO&&(dppAnotationId=e.annotationVO.annotationId);var t={annotationId:e.annotationVO.annotationId,dppContentId:e.annotationVO.annotationId,enclosingParaList:selectedParaIds,highlightColorCode:highLightColor,highlightEndOffset:highlightEndOffsetAtSectionLevel,highlightEndParaId:annotationEndParaId,highlightParaEndOffset:highlightEndOffset,highlightParaStartOffset:highlightStartOffset,highlightStartOffset:highlightStartOffsetAtSectionLevel,highlightStartParaId:annotationStartParaId,highlightText:highlightedTextWithoutHTML};if(selectedNoteId=dppAnotationId,highlightPalletsVisibleOnly=!1,e.annotationVO.annotationId){if(dppAnotationId=e.annotationVO.annotationId,0===highLightSpanIdAcrossPara.length){highLightSpanId=0,document.getElementById("note"+highLightSpanId).id=dppAnotationId;var a=document.getElementById(dppAnotationId);if(a.setAttribute("onClick","highLightedTextClick()"),a.addEventListener("keyup",highLightedTextOnEnter),a.setAttribute("startOffset",highlightStartOffsetAtSectionLevel),a.setAttribute("endOffset",highlightEndOffsetAtSectionLevel),a.setAttribute("tabindex","0"),a.setAttribute("highlightParaStartOffset",highlightStartOffset),a.setAttribute("highlightParaEndOffset",highlightEndOffset),a.setAttribute("highlightStartParaId",annotationStartParaId),a.setAttribute("highlightEndParaId",annotationEndParaId),a.setAttribute("enclosingParaIdString",""),$("#"+dppAnotationId).attr("style","background-color:"+highLightColor+" !important"),selectedHighlightColor=highLightColor,enableAnnotationForTouchDevices=!1,void 0!==a.children&&null!=a.children&&a.children.length>0){for(var n=[a],i=[],o=0;o<n.length;o++)-1===n[o].id.indexOf("_")&&i.push(n[o]);var r=i;for(o=0;o<r.length;o++){var s=r[o];multiParaAnnotationStartParaStartOffset=parseInt(s.getAttribute("highlightParaStartOffset")),multiParaAnnotationStartParaEndOffset=parseInt(s.getAttribute("highlightParaEndOffset")),multiParaHighlightIndexer=0,highlightTagFirstPart='<highlight id="',multiParaAnnotationID=s.id,highlightTagLastPart='" class="highlightedText" style="'+s.getAttribute("style")+'" data-references="popover" data-toggle="popover" data-original-title="" tabindex="0" title="" highlightParaStartOffset="'+s.getAttribute("highlightParaStartOffset")+'" highlightParaEndOffset="'+s.getAttribute("highlightParaEndOffset")+'" startOffset="'+s.getAttribute("startOffset")+'" endOffset="'+s.getAttribute("endOffset")+'" highlightStartparaid="'+s.getAttribute("highlightStartparaid")+'" highlightendparaid="'+s.getAttribute("highlightendparaid")+'"  enclosingParaIdString="'+enclosingParaIdString+'">';var l=s.getAttribute("highlightStartParaId"),d=document.getElementById(l);MARK=!1,addAnnotationMarkup(d,l),addAnnotationMarkupByOffestAndLengthForSinglePara(d,l,s.id)}setTimeout(function(){for(var e=0;e<r.length;e++)for(var t=$("highlight[id^="+r[e].id+"]"),a=0;a<t.length;a++)document.getElementById(t[a].id).setAttribute("onClick","highLightedTextClick()"),document.getElementById(t[a].id).addEventListener("keyup",highLightedTextOnEnter)},500);for(o=0;o<r.length;o++)for(var h=$("highlight[id^="+r[o].id+"]"),g=0;g<h.length;g++)void 0!==h[g].children[0]&&"highlight"===h[g].children[0].tagName.toLowerCase()&&1===h[g].children.length&&(h[g].innerHTML=h[g].children[0].innerHTML)}}else for(g=0;g<highLightSpanIdAcrossPara.length;g++){var c=dppAnotationId+"_"+highLightSpanIdAcrossPara[g];if(0===g&&(c=dppAnotationId),null!==document.getElementById("note"+highLightSpanIdAcrossPara[g])){document.getElementById("note"+highLightSpanIdAcrossPara[g]).id=c;var p=document.getElementById(c);p.setAttribute("onClick","highLightedTextClick()"),p.addEventListener("keyup",highLightedTextOnEnter),p.setAttribute("startOffset",highlightStartOffsetAtSectionLevel),p.setAttribute("endOffset",highlightEndOffsetAtSectionLevel),p.setAttribute("tabindex","0"),p.setAttribute("highlightParaStartOffset",highlightStartOffset),p.setAttribute("highlightParaEndOffset",highlightEndOffset),p.setAttribute("highlightStartParaId",annotationStartParaId),p.setAttribute("highlightEndParaId",annotationEndParaId);var u="";if(selectedParaIds.length>0)for(var f=0;f<selectedParaIds.length;f++)f===selectedParaIds.length-1?u+=selectedParaIds[f]:u+=selectedParaIds[f]+"|";if(p.setAttribute("enclosingParaIdString",u),$("#"+c).removeClass("ereader-selection-text-color"),$("#"+c).attr("style","background-color:"+highLightColor+" !important"),selectedHighlightColor=highLightColor,$("textarea#add-note-textarea")[1]||(enableAnnotationForTouchDevices=!1),void 0!==p.children&&null!=p.children&&p.children.length>0){for(n=[p],i=[],o=0;o<n.length;o++)-1===n[o].id.indexOf("_")&&i.push(n[o]);for(r=i,o=0;o<r.length;o++){s=r[o];multiParaAnnotationStartParaStartOffset=parseInt(s.getAttribute("highlightParaStartOffset")),multiParaAnnotationStartParaEndOffset=parseInt(s.getAttribute("highlightParaEndOffset")),multiParaHighlightIndexer=0,highlightTagFirstPart='<highlight id="',multiParaAnnotationID=s.id,highlightTagLastPart='" class="highlightedText" style="'+s.getAttribute("style")+'" data-references="popover" data-toggle="popover" data-original-title="" tabindex="0" title="" highlightParaStartOffset="'+s.getAttribute("highlightParaStartOffset")+'" highlightParaEndOffset="'+s.getAttribute("highlightParaEndOffset")+'" startOffset="'+s.getAttribute("startOffset")+'" endOffset="'+s.getAttribute("endOffset")+'" highlightStartparaid="'+s.getAttribute("highlightStartparaid")+'" highlightendparaid="'+s.getAttribute("highlightendparaid")+'"  enclosingParaIdString="'+enclosingParaIdString+'">';l=s.getAttribute("highlightStartParaId"),d=document.getElementById(l);MARK=!1,addAnnotationMarkup(d,l),addAnnotationMarkupByOffestAndLengthForSinglePara(d,l,s.id)}setTimeout(function(){for(var e=0;e<r.length;e++)for(var t=$("highlight[id^="+r[e].id+"]"),a=0;a<t.length;a++)document.getElementById(t[a].id).setAttribute("onClick","highLightedTextClick()"),document.getElementById(t[a].id).addEventListener("keyup",highLightedTextOnEnter)},500);for(o=0;o<r.length;o++){h=$("highlight[id^="+r[o].id+"]");for(var m=0;m<h.length;m++)void 0!==h[m].children[0]&&"highlight"===h[m].children[0].tagName.toLowerCase()&&1===h[m].children.length&&(h[m].innerHTML=h[m].children[0].innerHTML)}}}}checkSaveHighlight=!1}for(var I=$("highlight[id^="+dppAnotationId+"]"),C=0;C<I.length;C++)null!==I[C].parentNode&&null!==I[C].parentNode.className&&I[C].parentNode.className.indexOf("cc-pagenum-begin")>=0&&(I[C].parentNode.innerHTML=I[C].innerHTML);checkSaveNote=!0,addNotes(),""===globalChapterAnnotationList?(globalChapterAnnotationList=[],globalChapterAnnotationList.push(t)):globalChapterAnnotationList.push(t),sessionTimeOut()},function(e){sessionAuthFails(e),sessionTimeOut(),checkSaveHighlight=!1,Utility.handleSessionAuthentication(e.responseJSON)?(selectedNoteId="note"+highLightSpanId,removeDummyTags(),$("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain})}}function showHighLightPopoverAfterHighLight(e){null===e&&(e="note0"),document.getElementById("note"+highLightSpanId).id=e,document.getElementById(e).setAttribute("onClick","highLightedTextClick()"),document.getElementById(e).addEventListener("keyup",highLightedTextOnEnter),document.getElementById(e).setAttribute("startOffset",highlightStartOffset),document.getElementById(e).setAttribute("endOffset",highlightEndOffset),selectedNoteId=e,$("#page-loading-spinner").hide();document.getElementById(selectedNoteId);setTimeout(function(){if(addNotePopoverHighlight(),!insideEreader||"true"!=CaseConnect.welcomeCaseBriefInEreader||!insidePrincipalCase){var e=$('highlight[id^="note"]');e.length>1&&repaintSelectedText(e),1===e.length&&selectText("note0"),selectedHighlightColor="",changeHighlightImage(),setTimeout(function(){Clipboard.isSupported()||copyTextToClipBoard("copy");var e=$('highlight[id^="note"]');e.length>1&&repaintSelectedText(e),1===e.length&&selectText("note0"),selectedHighlightColor="",changeHighlightImage()},500)}},50);var t=document.getElementById(selectedNoteId).getBoundingClientRect();yValue=t.top}function addNotes(){if(checkSaveNote){if(null!=$("textarea#add-note-textarea")[1]||null!=$("textarea#add-note-textarea")[1])if(""!==$("textarea#add-note-textarea")[1].value){displayCommonAnnotationPopover=!1,$("#page-loading-spinner").show();var e,t=[];if(void 0!==$("#"+selectedNoteId).attr("highlightParaStartOffset"))if(highlightStartOffset=parseInt($("#"+selectedNoteId).attr("highlightParaStartOffset")),highlightEndOffset=parseInt($("#"+selectedNoteId).attr("highlightParaEndOffset")),t=[],i=$("#"+selectedNoteId).attr("enclosingParaIdString"),o=$("#"+selectedNoteId).attr("highlightStartParaId"),r=$("#"+selectedNoteId).attr("highlightEndParaId"),i.length>0)for(;i.length>0;)-1!==i.indexOf("|")?(t.push(i.substring(0,i.indexOf("|"))),i=i.substring(i.indexOf("|")+1)):(t.push(i),i="");else t.push(o);else if(e=$("highlight[id^="+selectedNoteId+"]").length>0?$("highlight[id^="+selectedNoteId+"]")[0].id:selectedNoteId,highlightStartOffset=parseInt($("#"+e).attr("highlightParaStartOffset")),highlightEndOffset=parseInt($("#"+e).attr("highlightParaEndOffset")),t=[],i=$("#"+e).attr("enclosingParaIdString"),o=$("#"+e).attr("highlightStartParaId"),r=$("#"+e).attr("highlightEndParaId"),i.length>0)for(;i.length>0;)-1!==i.indexOf("|")?(t.push(i.substring(0,i.indexOf("|"))),i=i.substring(i.indexOf("|")+1)):(t.push(i),i="");else t.push(o);var a=$("textarea#add-note-textarea")[1].value.replace(/</g,"&lt;").replace(/>/g,"&gt;"),n={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_ADD_NOTE",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{annotationId:selectedNoteId,bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,sectionId:annotationSectionId,sectionTitle:annotationSectionTitle,pageNumber:CaseConnect.currentPageNumber,highlightParaStartOffset:highlightStartOffset,highlightParaEndOffset:highlightEndOffset,noteText:a,highlightStartParaId:o,highlightEndParaId:r,enclosingParaList:t}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/addChapterNote",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(n)}).then(function(t){void 0!==t.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",t.sessionAuthenticationToken),null===document.getElementById(selectedNoteId)&&(selectedNoteId=e),yValue=document.getElementById(selectedNoteId).getBoundingClientRect().top,selectedHighlightColor||(selectedHighlightColor=document.getElementById(selectedNoteId).style.backgroundColor),localStorage.setItem("addNoteStartParaId",o),$("#"+o).next(),$("#"+o).next().is("p")&&localStorage.setItem("addNoteNextParaId",$("#"+o).next().attr("id")),displayNotesOnRight(a,selectedNoteId,yValue,selectedHighlightColor),setTimeout(function(){checkBriefOverNoteForOverlap()},800),checkSaveNote=!1,$("#"+dppAnotationId).popover("hide"),$(".delete-btn").css("visibility","visible")[1],ereaderEditMessageDisplayStatus(),alreadyCalled=!1,sessionTimeOut()},function(e){checkSaveNote=!1,sessionAuthFails(e),sessionTimeOut(),Utility.handleSessionAuthentication(e.responseJSON)?(addingNote=!1,$(".delete-btn").css("visibility","hidden")[1],closePopover(),$("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain,alreadyCalled=!1,checkSaveNote=!1})}else window.getSelection().removeAllRanges(),addingNote=!1,updatingNote=!1,$("#"+selectedNoteId).popover("hide"),$("#page-loading-spinner").hide();else if(navigator.userAgent.match(/(iPad|Android|iPhone)/))if($("textarea#add-note-textarea")[1]||highlightPaletteOnly)$("#page-loading-spinner").hide();else if($("textarea#add-note-textarea")[0].value=lostTextVal.value,lostTextVal="",$("textarea#add-note-textarea")[0])if(""!==$("textarea#add-note-textarea")[0].value){displayCommonAnnotationPopover=!1,$("#page-loading-spinner").show(),highlightStartOffset=parseInt($("#"+selectedNoteId).attr("startOffset")),highlightEndOffset=parseInt($("#"+selectedNoteId).attr("endOffset"));t=[];var i=$("#"+selectedNoteId).attr("enclosingParaIdString"),o=$("#"+selectedNoteId).attr("highlightStartParaId"),r=$("#"+selectedNoteId).attr("highlightEndParaId");if(i.length>0)for(;i.length>0;)-1!==i.indexOf("|")?(t.push(i.substring(0,i.indexOf("|"))),i=i.substring(i.indexOf("|")+1)):(t.push(i),i="");else t.push(o);a=$("textarea#add-note-textarea")[0].value.replace(/</g,"&lt;").replace(/>/g,"&gt;"),n={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_ADD_NOTE",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{annotationId:selectedNoteId,bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,sectionId:annotationSectionId,sectionTitle:annotationSectionTitle,pageNumber:CaseConnect.currentPageNumber,highlightParaStartOffset:highlightStartOffset,highlightParaEndOffset:highlightEndOffset,noteText:a,highlightStartParaId:o,highlightEndParaId:r,enclosingParaList:t}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/addChapterNote",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(n)}).then(function(e){$("#page-loading-spinner").show(),void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),yValue=document.getElementById(selectedNoteId).getBoundingClientRect().top,selectedHighlightColor||(selectedHighlightColor=document.getElementById(selectedNoteId).style.backgroundColor),localStorage.setItem("addNoteStartParaId",o),$("#"+o).next(),$("#"+o).next().is("p")&&localStorage.setItem("addNoteNextParaId",$("#"+o).next().attr("id")),displayNotesOnRight(a,selectedNoteId,yValue,selectedHighlightColor),setTimeout(function(){checkBriefOverNoteForOverlap()},800),checkSaveNote=!1,$("#page-loading-spinner").hide(),$("#"+dppAnotationId).popover("hide"),$(".delete-btn").css("visibility","visible")[1],ereaderEditMessageDisplayStatus(),alreadyCalled=!1,sessionTimeOut()},function(e){sessionAuthFails(e),sessionTimeOut(),Utility.handleSessionAuthentication(e.responseJSON)?(addingNote=!1,$(".delete-btn").css("visibility","hidden")[1],closePopover(),$("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain,checkSaveNote=!1,alreadyCalled=!1})}else window.getSelection().removeAllRanges(),$("#"+selectedNoteId).popover("hide"),$("#page-loading-spinner").hide();else $("#page-loading-spinner").hide();else $("#page-loading-spinner").hide();window.getSelection().removeAllRanges(),$("#"+selectedNoteId).popover("hide"),checkSaveNote=!1}}function updateHighlight(){var e=$("#"+selectedNoteId).css("background-color");if(selectedHighlightColor!==convertHexToRGB(e)&&selectedHighlightColor!==e){$("#page-loading-spinner").show(),highlightStartOffset=parseInt($("#"+selectedNoteId).attr("highlightparastartoffset")),highlightEndOffset=parseInt($("#"+selectedNoteId).attr("highlightparaendoffset")),highlightStartOffsetAtSectionLevel=$("#"+selectedNoteId).attr("startoffset"),highlightEndOffsetAtSectionLevel=$("#"+selectedNoteId).attr("endoffset"),annotationStartParaId=$("#"+selectedNoteId).attr("highlightstartparaid"),annotationEndParaId=$("#"+selectedNoteId).attr("highlightendparaid");var t;t=convertEnclosingParaStringIdToEnclosingParaArray($("#"+selectedNoteId).attr("enclosingparaidstring"));$("highlight[id^="+selectedNoteId+"]");if(globalChapterAnnotationList){for(var a="",n=0;n<globalChapterAnnotationList.length;n++)if(selectedNoteId===globalChapterAnnotationList[n].annotationId){a=globalChapterAnnotationList[n].highlightText,highlightedTextWithoutHTML=a;break}""===a&&getHighlightTextInCopy()}else getHighlightTextInCopy();var i=selectedNoteId;if(-1!==selectedNoteId.indexOf("_")&&(i=selectedNoteId.substring(0,selectedNoteId.indexOf("_"))),void 0!==$("textarea#add-note-textarea")[1])var o=$("textarea#add-note-textarea")[1].value.replace(/</g,"&lt;").replace(/>/g,"&gt;");var r={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_UPDATE_HIGHLIGHT",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{annotationId:i,bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,sectionId:annotationSectionId,sectionTitle:annotationSectionTitle,pageNumber:CaseConnect.currentPageNumber,highlightParaStartOffset:highlightStartOffset,highlightParaEndOffset:highlightEndOffset,highlightText:highlightedTextWithoutHTML,highlightColorCode:highLightColor,highlightStartOffset:highlightStartOffsetAtSectionLevel,highlightEndOffset:highlightEndOffsetAtSectionLevel,highlightStartParaId:annotationStartParaId,highlightEndParaId:annotationEndParaId,enclosingParaList:t}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/updateChapterHighlights",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(r)}).then(function(e){void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken);for(var t=$("highlight[id^="+selectedNoteId+"]"),a=0;a<t.length;a++)$("highlight#"+t[a].id).attr("style","background-color:"+highLightColor+" !important;");if(selectedHighlightColor=highLightColor,updateHighlightCalledFromPallets=!1,""!==o){if(addingNote&&!updatingNote)checkSaveNote=!0,addNotes();else if(!addingNote&&updatingNote){updateNotes(),updatingNote=!1,$("highlight#"+selectedNoteId).attr("style","background-color:"+highLightColor+" !important;"),selectedHighlightColor=highLightColor,yValue=document.getElementById(selectedNoteId).getBoundingClientRect().top;for(var n=$(".notesText"),i=0;i<n.length;i++)if(n[i].id.substring(8,n[i].id.length)===selectedNoteId){n[i].parentNode.removeChild(n[i]);break}var r=$(".notesSpanBlock");for(i=0;i<r.length;i++)if(r[i].id===selectedNoteId){r[i].parentNode.removeChild(r[i]);break}alreadyCalled=!1,addingNote=!1,localStorage.setItem("addNoteStartParaId",annotationStartParaId),$("#"+annotationStartParaId).next(),$("#"+annotationStartParaId).next().is("p")&&localStorage.setItem("addNoteNextParaId",$("#"+annotationStartParaId).next().attr("id")),displayNotesOnRight(o,selectedNoteId,yValue,selectedHighlightColor),setTimeout(function(){checkBriefOverNoteForOverlap()},800),$("#"+selectedNoteId).popover("hide"),$("#page-loading-spinner").hide()}}else if(""===o){updatingNote=!1,addingNote=!1;for(n=$(".notesText"),i=0;i<n.length;i++){if(n[i].id.substring(8,n[i].id.length)===selectedNoteId){deleteNoteOnColorChange=!0;break}deleteNoteOnColorChange=!1}deleteNoteOnColorChange?(deleteNoteOnColorChange=!1,deleteNotes()):($("#"+selectedNoteId).popover("hide"),$("#page-loading-spinner").hide())}$(".delete-btn").css("visibility","visible")[1],$("#"+selectedNoteId).popover("hide"),$("#page-loading-spinner").hide(),sessionTimeOut()},function(e){sessionAuthFails(e),sessionTimeOut(),Utility.handleSessionAuthentication(e.responseJSON)?($("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain})}}function removeHighlightFromPageNumbers(){var e=document.getElementsByTagName("highlight"),t=document.getElementsByTagName("anchortag"),a=document.getElementsByTagName("briefstag");if(e)for(var n=0;n<e.length;n++)"span"===e[n].parentNode.tagName.toLowerCase()&&$(e[n].parentNode).hasClass("cc-pagenum-begin")&&(e[n].parentNode.innerHTML=e[n].textContent);if(t)for(n=0;n<t.length;n++)"span"===t[n].parentNode.tagName.toLowerCase()&&$(t[n].parentNode).hasClass("cc-pagenum-begin")&&(t[n].parentNode.innerHTML=t[n].textContent);if(a)for(n=0;n<a.length;n++)"span"===a[n].parentNode.tagName.toLowerCase()&&$(a[n].parentNode).hasClass("cc-pagenum-begin")&&(a[n].parentNode.innerHTML=a[n].textContent)}function convertEnclosingParaStringIdToEnclosingParaArray(e){var t=[];if(e.length>0)for(;e.length>0;)-1!==e.indexOf("|")?(t.push(e.substring(0,e.indexOf("|"))),e=e.substring(e.indexOf("|")+1)):(t.push(e),e="");else t.push(annotationStartParaId);return t}function updateNotes(){if($("textarea#add-note-textarea")[1])if("visible"===$(".save-note-icon").css("visibility")){$(".save-note-icon").css("visibility","hidden"),highlightStartOffset=parseInt($("#"+selectedNoteId).attr("highlightparastartoffset")),highlightEndOffset=parseInt($("#"+selectedNoteId).attr("highlightparaendoffset"));var e=[],t=$("#"+selectedNoteId).attr("enclosingParaIdString"),a=$("#"+selectedNoteId).attr("highlightStartParaId"),n=$("#"+selectedNoteId).attr("highlightEndParaId");if(t.length>0)for(;t.length>0;)-1!==t.indexOf("|")?(e.push(t.substring(0,t.indexOf("|"))),t=t.substring(t.indexOf("|")+1)):(e.push(t),t="");else e.push(a);var i=selectedNoteId;-1!==selectedNoteId.indexOf("_")&&(i=selectedNoteId.substring(0,selectedNoteId.indexOf("_")));var o=$("textarea#add-note-textarea")[1].value.replace(/</g,"&lt;").replace(/>/g,"&gt;");$("#page-loading-spinner").show();var r={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_UPDATE_NOTE",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{annotationId:i,bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,sectionId:annotationSectionId,sectionTitle:annotationSectionTitle,pageNumber:CaseConnect.currentPageNumber,highlightParaStartOffset:highlightStartOffset,highlightParaEndOffset:highlightEndOffset,noteText:o,highlightStartParaId:a,highlightEndParaId:n,enclosingParaList:e}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/updateChapterNote",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(r)}).then(function(e){void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),yValue=document.getElementById(selectedNoteId).getBoundingClientRect().top,selectedHighlightColor||(selectedHighlightColor=document.getElementById(selectedNoteId).style.backgroundColor);for(var t=$(".notesText"),n=0;n<t.length;n++)if(t[n].id.substring(8,t[n].id.length)===selectedNoteId){t[n].parentNode.removeChild(t[n]);break}var i=$(".notesSpanBlock");for(n=0;n<i.length;n++)if(i[n].id===selectedNoteId){i[n].parentNode.removeChild(i[n]);break}updatingNote=!1,localStorage.setItem("addNoteStartParaId",a),$("#"+a).next(),$("#"+a).next().is("p")&&localStorage.setItem("addNoteNextParaId",$("#"+a).next().attr("id")),displayNotesOnRight(o,selectedNoteId,yValue,selectedHighlightColor),setTimeout(function(){checkBriefOverNoteForOverlap()},800),$(".delete-btn").css("visibility","visible")[1],$("#"+selectedNoteId).popover("hide"),$("#"+selectedNoteId).focus(),$("#page-loading-spinner").hide(),alreadyCalled=!1,sessionTimeOut()},function(e){sessionAuthFails(e),sessionTimeOut(),Utility.handleSessionAuthentication(e.responseJSON)?($("#page-loading-spinner").hide(),updatingNote=!1,closePopover(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain,alreadyCalled=!1})}else $("#"+selectedNoteId).popover("hide"),updatingNote=!1,alreadyCalled=!1}function deleteCurrentHighlight(){$("#page-loading-spinner").show();var e={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_DELETE_HIGHLIGHT",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{annotationId:selectedNoteId,bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,annotationType:"annotation"}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/deleteChapterHighlights",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(e)}).then(function(e){void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),$("#page-loading-spinner").hide(),addingNote=!1,updatingNote=!1,closePopover();var t=$("highlight[id^="+selectedNoteId+"]");if(highlightStartOffset=parseInt(t[0].getAttribute("highlightparastartoffset")),highlightEndOffset=parseInt(t[0].getAttribute("highlightparaendoffset")),highlightStartOffsetAtSectionLevel=t[0].getAttribute("startoffset"),highlightEndOffsetAtSectionLevel=t[0].getAttribute("endoffset"),annotationStartParaId=t[0].getAttribute("highlightstartparaid"),annotationEndParaId=t[0].getAttribute("highlightendparaid"),saveHighlightsRequestData=highlightStartOffsetAtSectionLevel+"_"+highlightEndOffsetAtSectionLevel+"_"+annotationStartParaId+"_"+annotationEndParaId+"_"+highlightStartOffset+"_"+highlightEndOffset,void 0!==localStorage.getItem("annotationListForChapter")&&null!==localStorage.getItem("annotationListForChapter"))for(var a=localStorage.getItem("annotationListForChapter").split(","),n=0;n<a.length;n++)a[n]===saveHighlightsRequestData&&allExistingAnnotationUniqueVal.splice(n,1);localStorage.setItem("annotationListForChapter",allExistingAnnotationUniqueVal);for(var i=0;i<t.length;i++){var o=document.getElementById(t[i].id),r=document.createElement("span");r.innerHTML=o.innerHTML,r.normalize(),o.parentNode.replaceChild(r,o)}var s=$(".notesText");for(i=0;i<s.length;i++)if(s[i].id.substring(8,s[i].id.length)===selectedNoteId){s[i].parentNode.removeChild(s[i]);break}var l=$(".notesSpanBlock");for(i=0;i<l.length;i++)if(l[i].id===selectedNoteId){l[i].parentNode.removeChild(l[i]);break}for(var d=0;d<globalChapterAnnotationList.length;d++)selectedNoteId===globalChapterAnnotationList[d].annotationId&&globalChapterAnnotationList.splice(d,1);sessionTimeOut()},function(e){sessionTimeOut(),sessionAuthFails(e),Utility.handleSessionAuthentication(e.responseJSON)?($("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg),closePopover()):window.location=properties.ui_domain})}function deleteNotes(){$("#page-loading-spinner").show(),highlightStartOffset=parseInt($("#"+selectedNoteId).attr("highlightparastartoffset")),highlightEndOffset=parseInt($("#"+selectedNoteId).attr("highlightparaendoffset"));var e=[],t=$("#"+selectedNoteId).attr("enclosingParaIdString"),a=$("#"+selectedNoteId).attr("highlightStartParaId"),n=$("#"+selectedNoteId).attr("highlightEndParaId");if(t.length>0)for(;t.length>0;)-1!==t.indexOf("|")?(e.push(t.substring(0,t.indexOf("|"))),t=t.substring(t.indexOf("|")+1)):(e.push(t),t="");else e.push(a);var i={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_ANNOTATION_DELETE_NOTE",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{annotationId:selectedNoteId,bookId:CaseConnect.currentBookId,chapterId:CaseConnect.currentChapterId,chapterTitle:CaseConnect.currentChapterTitle,sectionId:CaseConnect.currentSectionId,sectionTitle:currentSectionTitle,highlightParaStartOffset:highlightStartOffset,highlightParaEndOffset:highlightEndOffset,highlightStartParaId:a,highlightEndParaId:n,enclosingParaList:e}};$.ajax({url:properties[properties.env]+"/manageAnnotationService/deleteChapterNote",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(i)}).then(function(e){void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),$("#page-loading-spinner").hide();for(var t=$(".notesText"),a=0;a<t.length;a++)if(t[a].id.substring(8,t[a].id.length)===selectedNoteId){t[a].parentNode.removeChild(t[a]);break}var n=$(".notesSpanBlock");for(a=0;a<n.length;a++)if(n[a].id===selectedNoteId){n[a].parentNode.removeChild(n[a]);break}showAddNotePopoverOnly(),showAddBriefPopoverOnly(),addingNote=!1,updatingNote=!1,addingBrief=!1,updatingBrief=!1,closePopover(),alreadyCalled=!1,setTimeout(function(){$("#"+selectedNoteId).focus()},300),sessionTimeOut()},function(e){sessionAuthFails(e),sessionTimeOut(),Utility.handleSessionAuthentication(e.responseJSON)?($("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg),addingNote=!1,updatingNote=!1):window.location=properties.ui_domain,alreadyCalled=!1})}function HTMLDecode(e){return jQuery("<div></div>").html(e).text()}function fetchAnnotations(e,t){var a="";"chapter"===CaseConnect.bookData.chapterType||!loadingAnnotationsFromTOC||"true"===CaseConnect.bookData.isAnnotatable||comingFromAnnotationPrevNextBtn||insideCasesPage?insideCasesPage&&(e=casesSectionListOnLoad.chapterId,a=casesSectionListOnLoad.sectionId):($("#previousChapterAnnotationArrow").css("visibility","hidden"),loadingAnnotationsFromTOC=!1,annotationListingChapterId=bookAnnotateFileList[0].chapterId,$(".annotationListChapterName").html(bookAnnotateFileList[0].navbarTitle),$(".annotationListChapterName").attr("aria-label",bookAnnotateFileList[0].navbarTitle),e=bookAnnotateFileList[0].chapterId);var n={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01",lastViewedOutlineId:CaseConnect.lastViewedOutlineId},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},annotationVO:{pageNum:0,bookId:CaseConnect.currentBookId,chapterId:e,ereaderNotesAndHighlightsPopoverFlowFlag:fetchingAnnotationsForListing}};null!=t&&""!=t&&(n.annotationVO.pageNum=t),insideEreader?(n.userVO.userActivityVO.lastActivityCode="EREADER_ANNOTATION_GET",n.userVO.userActivityVO.pageNavigatingFrom="EReader",n.userVO.userActivityVO.pageNavigatingTo="EReader"):(n.userVO.userActivityVO.lastActivityCode="CASE_PAGE",n.userVO.userActivityVO.pageNavigatingFrom="CASES",n.userVO.userActivityVO.pageNavigatingTo="CASES",""!==a&&(n.annotationVO.sectionIdList=[a])),$.ajax({url:properties[properties.env]+"/manageAnnotationService/getChapterAnnotations",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(n)}).then(function(e){if(void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),fetchingAnnotationsForListing){if($("#ereader-menu-popover-content div.notes-highlights-popover-content").empty(),comingFromAnnotationPrevNextBtn=!1,e.annotationVOList){d=[];var a=[],n=[];a=e;Array.isArray(a.annotationVOList)||(a.annotationVOList=[a.annotationVOList]),e.annotationVOList.length>0?(e.annotationVOList=e.annotationVOList,d=e.annotationVOList):(e.annotationVOList.push(e.annotationVOList),d.push(e.annotationVOList));var i=null,o=null;for(C=0;C<a.annotationVOList.length;C++)i!==a.annotationVOList[C].sectionId&&(i=a.annotationVOList[C].sectionId,o=a.annotationVOList[C].sectionTitle,fetchedSectionOtherInfo=[],a.annotationVOList[C].noteText?a.annotationVOList[C].labelName?fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C].annotationId,pageNumber:a.annotationVOList[C].pageNumber,highlightColorCode:a.annotationVOList[C].highlightColorCode,highlightText:a.annotationVOList[C].highlightText,noteText:a.annotationVOList[C].noteText.replace(/&lt;/g,"<").replace(/&gt;/g,">"),labelName:a.annotationVOList[C].labelName.replace(/&lt;/g,"<").replace(/&gt;/g,">")}):fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C].annotationId,pageNumber:a.annotationVOList[C].pageNumber,highlightColorCode:a.annotationVOList[C].highlightColorCode,highlightText:a.annotationVOList[C].highlightText,noteText:a.annotationVOList[C].noteText.replace(/&lt;/g,"<").replace(/&gt;/g,">")}):a.annotationVOList[C].labelName?fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C].annotationId,pageNumber:a.annotationVOList[C].pageNumber,highlightColorCode:a.annotationVOList[C].highlightColorCode,highlightText:a.annotationVOList[C].highlightText,labelName:a.annotationVOList[C].labelName.replace(/&lt;/g,"<").replace(/&gt;/g,">")}):fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C].annotationId,pageNumber:a.annotationVOList[C].pageNumber,highlightColorCode:a.annotationVOList[C].highlightColorCode,highlightText:a.annotationVOList[C].highlightText})),void 0!==a.annotationVOList[C+1]&&i===a.annotationVOList[C+1].sectionId?a.annotationVOList[C+1].noteText?a.annotationVOList[C+1].labelName?fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C+1].annotationId,pageNumber:a.annotationVOList[C+1].pageNumber,highlightColorCode:a.annotationVOList[C+1].highlightColorCode,highlightText:a.annotationVOList[C+1].highlightText,noteText:a.annotationVOList[C+1].noteText.replace(/&lt;/g,"<").replace(/&gt;/g,">"),labelName:a.annotationVOList[C+1].labelName.replace(/&lt;/g,"<").replace(/&gt;/g,">")}):fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C+1].annotationId,pageNumber:a.annotationVOList[C+1].pageNumber,highlightColorCode:a.annotationVOList[C+1].highlightColorCode,highlightText:a.annotationVOList[C+1].highlightText,noteText:a.annotationVOList[C+1].noteText.replace(/&lt;/g,"<").replace(/&gt;/g,">")}):a.annotationVOList[C+1].labelName?fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C+1].annotationId,pageNumber:a.annotationVOList[C+1].pageNumber,highlightColorCode:a.annotationVOList[C+1].highlightColorCode,highlightText:a.annotationVOList[C+1].highlightText,labelName:a.annotationVOList[C+1].labelName.replace(/&lt;/g,"<").replace(/&gt;/g,">")}):fetchedSectionOtherInfo.push({annotationId:a.annotationVOList[C+1].annotationId,pageNumber:a.annotationVOList[C+1].pageNumber,highlightColorCode:a.annotationVOList[C+1].highlightColorCode,highlightText:a.annotationVOList[C+1].highlightText}):n.push({sectionId:i,sectionTitle:o,fetchedSectionOtherInfo:fetchedSectionOtherInfo});a.annotationVOList=n;var r=Handlebars.getTemplate("ereader-notes-popover")(a);$("#ereader-menu-popover-content div.notes-highlights-popover-content").html(r),$("#previousChapterAnnotationArrow").attr("disabled",!1),$("#nextChapterAnnotationArrow").attr("disabled",!1);for(C=0;C<d.length;C++){var s=document.getElementById("highlightElement"+d[C].annotationId);document.getElementById("addnotessElement"+d[C].annotationId);$clamp(s,{clamp:5})}$("#notesSpinner").hide(),$("button#previousChapterAnnotationArrow").attr("disabled",!1),$("button#nextChapterAnnotationArrow").attr("disabled",!1)}else if(!e.annotationVOList){var l=document.createElement("DIV");l.className="annotations-not-present-msg",l.innerHTML="You do not yet have highlights and notes in this chapter.",$(".notes-highlights-popover-content").append(l),$("button#previousChapterAnnotationArrow").attr("disabled",!1),$("button#nextChapterAnnotationArrow").attr("disabled",!1),$("#notesSpinner").hide()}fetchingAnnotationsForListing=!1}else{if(null!=t&&null!=t||($(".notesText").remove(),$(".notesSpanBlock").remove()),e.annotationVOList){var d=[];e.annotationVOList.length>0?d=e.annotationVOList:d.push(e.annotationVOList);var h,g={},c=[],p=null,u="";globalChapterAnnotationList=null==t||null==t?d:globalChapterAnnotationList.concat(d);for(var f=0;f<globalChapterAnnotationList.length;f++){var m=globalChapterAnnotationList[f].highlightStartOffset+"_"+globalChapterAnnotationList[f].highlightEndOffset+"_"+globalChapterAnnotationList[f].highlightStartParaId+"_"+globalChapterAnnotationList[f].highlightEndParaId+"_"+globalChapterAnnotationList[f].highlightParaStartOffset+"_"+globalChapterAnnotationList[f].highlightParaEndOffset;allExistingAnnotationUniqueVal.push(m)}if(localStorage.setItem("annotationListForChapter",allExistingAnnotationUniqueVal),insideEreader)var I=$(".ereader-content");if(insideCasesPage)I=$("#case-excerpt-block-cases");for(var C=0;C<d.length;C++)if(void 0!==d[C].highlightEndParaId&&void 0!==d[C].highlightStartParaId&&null!==d[C].highlightEndParaId&&null!==d[C].highlightStartParaId&&0!==d[C].highlightEndParaId.length&&0!==d[C].highlightStartParaId.length&&null!==I.find("#"+d[C].highlightEndParaId)[0]&&null!==I.find("#"+d[C].highlightStartParaId)[0]&&void 0!==I.find("#"+d[C].highlightEndParaId)[0]&&void 0!==I.find("#"+d[C].highlightStartParaId)[0]){var v=!1;null!==d[C].enclosingParaList&&d[C].highlightStartParaId!==d[C].highlightEndParaId&&(v=!0,g[d[C].annotationId]=d[C],c.push(d[C].annotationId)),d[C].highlightStartParaId!==p&&(null!==p&&I.find("#"+p)[0]&&(I.find("#"+p)[0].outerHTML=h),p=d[C].highlightStartParaId,h=(h=(h=(h=I.find("#"+d[C].highlightStartParaId)[0]?I.find("#"+d[C].highlightStartParaId)[0].outerHTML:"").replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "));var P=h;if(enclosingParaIdString="",null!==d[C].enclosingParaList&&void 0!==d[C].enclosingParaList){if("string"==$.type(d[C].enclosingParaList))enclosingParaIdString=d[C].highlightStartParaId;else for(var T=0;T<d[C].enclosingParaList.length;T++){var S=T===d[C].enclosingParaList.length-1?"":"|";enclosingParaIdString+=d[C].enclosingParaList[T]+S}}for(var O,b='<highlight id="'+d[C].annotationId+'" class="highlightedText" style="background-color: '+d[C].highlightColorCode+' !important;" tabindex="0" data-references="popover" data-toggle="popover" data-original-title="" title="" highlightParaStartOffset="'+d[C].highlightParaStartOffset+'" highlightParaEndOffset="'+d[C].highlightParaEndOffset+'" startOffset="'+d[C].highlightStartOffset+'" endOffset="'+d[C].highlightEndOffset+'" highlightStartParaId="'+d[C].highlightStartParaId+'"  highlightEndParaId="'+d[C].highlightEndParaId+'" enclosingParaIdString="'+enclosingParaIdString+'">',N=0,L=/<\/*([a-z][a-z0-9]*)\b[^>]*>(.*?)/;(O=L.exec(P))&&!(O.index>d[C].highlightParaStartOffset);)P=P.replace(O[0],""),N+=O[0].length;var A=parseInt(d[C].highlightParaStartOffset)+N,x="";if(null!==I.find("#"+d[C].highlightStartParaId)[0]&&void 0!==I.find("#"+d[C].highlightStartParaId)[0]&&(x=I.find("#"+d[C].highlightStartParaId)[0].outerHTML),x=(x=(x=x.replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," "),v)for(;(O=L.exec(P))&&!(O.index>x.length);)P=P.replace(O[0],""),N+=O[0].length,O[0].length;else for(;(O=L.exec(P))&&!(O.index>d[C].highlightParaEndOffset);)P=P.replace(O[0],""),N+=O[0].length;var E=parseInt(d[C].highlightParaEndOffset)+N;if(v){E=h.length;h.substring(A,E);var y=I.find("#"+d[C].highlightStartParaId)[0];$(y).contents();h=h.substring(0,A)+b+h.substring(A,E)+"</highlight>"+h.substring(E),I.find("#"+d[C].highlightEndParaId)[0]&&(u=I.find("#"+d[C].highlightEndParaId)[0].outerHTML),P=u=(u=(u=u.replace(/(\r\n|\n|\r)/gm,"")).replace(/amp;/g,"")).replace(/&nbsp;/g," ");for(var k=0;k<d[C].enclosingParaList.length;k++)if(d[C].enclosingParaList[k]!==d[C].highlightStartParaId&&d[C].enclosingParaList[k]!==d[C].highlightEndParaId){var M=document.getElementById(d[C].enclosingParaList[k]);d[C].annotationId,d[C].highlightColorCode,d[C].highlightParaStartOffset,d[C].highlightParaEndOffset,d[C].highlightStartOffset,d[C].highlightEndOffset;null!==M&&(M.innerHTML='<highlight id="'+d[C].annotationId+"_"+k+"_"+k+'" class="highlightedText" style="background-color: '+d[C].highlightColorCode+' !important;" data-references="popover" data-toggle="popover" tabindex="0" data-original-title="" title="" highlightParaStartOffset="'+d[C].highlightParaStartOffset+'" highlightParaEndOffset="'+d[C].highlightParaEndOffset+'" startOffset="'+d[C].highlightStartOffset+'" endOffset="'+d[C].highlightEndOffset+'"  enclosingParaIdString="'+enclosingParaIdString+'">'+M.innerHTML+"</highlight>")}for(var H=0,w=0;(O=L.exec(P))&&!(O.index>0);)P=P.replace(O[0],""),H+=O[0].length,O[0].length;for(;(O=L.exec(P))&&!(O.index>d[C].highlightParaEndOffset);)P=P.replace(O[0],""),O[0].length,w+=O[0].length;var B=$(u).children()[0],R=0;null!=B&&null!=B.getAttribute("class")&&-1!==B.getAttribute("class").indexOf("cc-pagenum-begin")&&(R=B.innerHTML.length+"</span>".length);H+=R;var V=u.substring(H).indexOf(u.substring(H).trim());u=u.substring(0,H)+'<highlight id="'+d[C].annotationId+'_1" class="highlightedText" style="background-color: '+d[C].highlightColorCode+' !important;" data-references="popover" data-toggle="popover" data-original-title="" title="" tabindex="0" highlightParaStartOffset="'+d[C].highlightParaStartOffset+'" highlightParaEndOffset="'+d[C].highlightParaEndOffset+'" startOffset="'+d[C].highlightStartOffset+'" endOffset="'+d[C].highlightEndOffset+'"  enclosingParaIdString="'+enclosingParaIdString+'">'+u.substring(H+V,H+V+parseInt(d[C].highlightParaEndOffset)+w-R)+"</highlight>"+u.substring(H+V+parseInt(d[C].highlightParaEndOffset)+w-R),null!==d[C].highlightEndParaId&&I.find("#"+d[C].highlightEndParaId)[0]&&(I.find("#"+d[C].highlightEndParaId)[0].outerHTML=u)}else h=(h=C>0&&d[C].highlightParaEndOffset===d[C-1].highlightParaStartOffset?h.substring(0,E-1)+"</highlight>"+h.substring(E):h.substring(0,E)+"</highlight>"+h.substring(E)).substring(0,A)+b+h.substring(A)}I.find("#"+p)[0]&&(I.find("#"+p)[0].outerHTML=h);for(var F=document.getElementsByTagName("highlight"),D=[],C=0;C<F.length;C++)void 0===g[F[C].id]&&-1===F[C].id.indexOf("_")&&D.push(F[C]);setTimeout(function(){for(var e=0;e<c.length;e++){var t=I.find("#"+c[e])[0];multiParaAnnotationStartParaStartOffset=t.getAttribute("highlightParaStartOffset"),multiParaAnnotationStartParaEndOffset=t.textContent.length,multiParaHighlightIndexer=0,highlightTagFirstPart='<highlight id="',multiParaAnnotationID=c[e],highlightTagLastPart='" class="highlightedText" style="'+t.getAttribute("style")+'" data-references="popover" data-toggle="popover" data-original-title="" tabindex="0" title="" highlightParaStartOffset="'+t.getAttribute("highlightParaStartOffset")+'" highlightParaEndOffset="'+t.getAttribute("highlightParaEndOffset")+'" startOffset="'+t.getAttribute("startOffset")+'" endOffset="'+t.getAttribute("endOffset")+'" highlightStartparaid="'+t.getAttribute("highlightStartparaid")+'" highlightendparaid="'+t.getAttribute("highlightendparaid")+'"  enclosingParaIdString="'+enclosingParaIdString+'">';var a=t.getAttribute("highlightStartParaId"),n=I.find("#"+a)[0];MARK=!1,addAnnotationMarkup(n,a),addAnnotationMarkupByOffestAndLength1(n,a,c[e]),a=t.getAttribute("highlightEndParaId"),n=I.find("#"+a)[0];var i=$(n).children()[0];null!=i&&void 0!==i.getAttribute("class")&&null!==i.getAttribute("class")&&-1!==i.getAttribute("class").indexOf("cc-pagenum-begin")&&i.innerHTML.length+"</span>".length,multiParaAnnotationStartParaStartOffset=0,multiParaAnnotationStartParaEndOffset=parseInt(t.getAttribute("highlightParaEndOffset")),MARK=!1,addAnnotationMarkup(n,a),addAnnotationMarkupByOffestAndLength(n,a,c[e],!0)}setTimeout(function(){for(var e=0;e<c.length;e++)for(var t=$("highlight[id^="+c[e]+"]"),a=0;a<t.length;a++)document.getElementById(t[a].id).setAttribute("onClick","highLightedTextClick()"),document.getElementById(t[a].id).addEventListener("keyup",highLightedTextOnEnter)},500);var o=D;for(e=0;e<o.length;e++){t=o[e];multiParaAnnotationStartParaStartOffset=parseInt(t.getAttribute("highlightParaStartOffset")),multiParaAnnotationStartParaEndOffset=parseInt(t.getAttribute("highlightParaEndOffset")),multiParaHighlightIndexer=0,highlightTagFirstPart='<highlight id="',multiParaAnnotationID=t.id,highlightTagLastPart='" class="highlightedText" style="'+t.getAttribute("style")+'" data-references="popover" data-toggle="popover" data-original-title="" tabindex="0" title="" highlightParaStartOffset="'+t.getAttribute("highlightParaStartOffset")+'" highlightParaEndOffset="'+t.getAttribute("highlightParaEndOffset")+'" startOffset="'+t.getAttribute("startOffset")+'" endOffset="'+t.getAttribute("endOffset")+'" highlightStartparaid="'+t.getAttribute("highlightStartparaid")+'" highlightendparaid="'+t.getAttribute("highlightendparaid")+'"  enclosingParaIdString="'+enclosingParaIdString+'">';a=t.getAttribute("highlightStartParaId"),n=I.find("#"+a)[0];MARK=!1,addAnnotationMarkup(n,a),addAnnotationMarkupByOffestAndLengthForSinglePara(n,a,t.id)}setTimeout(function(){for(var e=0;e<o.length;e++)for(var t=$("highlight[id^="+o[e].id+"]"),a=0;a<t.length;a++)document.getElementById(t[a].id).setAttribute("onClick","highLightedTextClick()"),document.getElementById(t[a].id).addEventListener("keyup",highLightedTextOnEnter)},500);for(e=0;e<o.length;e++)for(var r=$("highlight[id^="+o[e].id+"]"),s=0;s<r.length;s++)void 0!==r[s].children[0]&&"highlight"===r[s].children[0].tagName.toLowerCase()&&1===r[s].children.length&&(r[s].innerHTML=r[s].children[0].innerHTML);for(e=0;e<d.length;e++)if(dppAnotationId=d[e].annotationId,document.getElementById(dppAnotationId)&&(document.getElementById(dppAnotationId).setAttribute("onClick","highLightedTextClick()"),document.getElementById(dppAnotationId).addEventListener("keyup",highLightedTextOnEnter),d[e].noteText)){selectedNoteId=dppAnotationId,bodyRect=document.body.getBoundingClientRect(),selectedHighlightColor=d[e].highlightColorCode;var l=document.getElementById(selectedNoteId).getBoundingClientRect();yValue=l.top,closePrintClicked=!1,displayNotesOnRight(d[e].noteText.replace(/</g,"&lt;").replace(/>/g,"&gt;"),selectedNoteId,yValue,selectedHighlightColor);var h=300;(h=null!==localStorage.getItem("annotationListForChapter")?localStorage.getItem("annotationListForChapter").split(",").length:1e3)<50?setTimeout(function(){reCalculateNotesOnRight()},400):h>50&&h<150?setTimeout(function(){reCalculateNotesOnRight()},400):h>150&&h<400?setTimeout(function(){reCalculateNotesOnRight()},600):h>400&&h<800?setTimeout(function(){reCalculateNotesOnRight()},800):h>800&&h<1500?setTimeout(function(){reCalculateNotesOnRight()},1e3):setTimeout(function(){reCalculateNotesOnRight()},3e3),$("#page-loading-spinner").show()}if(insideEreader&&loadingNewChapterFromAnnotationListing&&I.find("#"+clickedAnnotationIdFromListing)[0]){var g=I.find("#"+clickedAnnotationIdFromListing)[0],p=document.getElementById("ereader-scroller");$("ol.epub-parenlistlcletter li").addClass("goToPageBug"),$("ol.epub-parenlistucletter li").addClass("goToPageBug"),$("ol.epub-parenlistdecimal li").addClass("goToPageBug"),$("ol.epub-bracketlistdecimal li").addClass("goToPageBug"),$("ol.epub-ucletter li").addClass("goToPageBug"),$("ol.epub-lcletter li").addClass("goToPageBug"),$("ol.epub-ucroman li").addClass("goToPageBug"),$("ol.epub-lcroman li").addClass("goToPageBug"),$("ol.epub-decimal li").addClass("goToPageBug"),$(".epub-law-heading-container").addClass("goToPageBug"),$(".epub-law-case-marker").addClass("goToPageBug"),p.scrollTop=g.offsetTop,$("ol.epub-parenlistlcletter li").removeClass("goToPageBug"),$("ol.epub-parenlistucletter li").removeClass("goToPageBug"),$("ol.epub-parenlistdecimal li").removeClass("goToPageBug"),$("ol.epub-bracketlistdecimal li").removeClass("goToPageBug"),$("ol.epub-ucletter li").removeClass("goToPageBug"),$("ol.epub-lcletter li").removeClass("goToPageBug"),$("ol.epub-ucroman li").removeClass("goToPageBug"),$("ol.epub-lcroman li").removeClass("goToPageBug"),$("ol.epub-decimal li").removeClass("goToPageBug"),$(".epub-law-case-marker").removeClass("goToPageBug"),$(".epub-law-heading-container").removeClass("goToPageBug"),updatePageNoAndChapterName(),loadingNewChapterFromAnnotationListing=!1}removeHighlightFromPageNumbers()},1e3)}setTimeout(function(){if(document.getElementById("next-chapter-button-bottom"))if(bookChapterSupplimentList)for(var e=0;e<bookChapterSupplimentList.length;e++)CaseConnect.currentChapterId===bookChapterSupplimentList[e].chapterId&&bookChapterSupplimentList[e+1]&&($("#nextChapterFromBottomPage")[0].innerHTML=bookChapterSupplimentList[e+1].navbarTitle,CaseConnect.nextChapterStartPageNumber!==bookChapterSupplimentList[e+1].strStartPageNumber&&(CaseConnect.nextChapterStartPageNumber=bookChapterSupplimentList[e+1].strStartPageNumber));else getChapterAndSupplementalList();$("#txtPageNum").val(CaseConnect.currentPageNumber),$("#txtPageNumMobile").val(CaseConnect.currentPageNumber),$("#page-loading-spinner").show(),"iOS"===CaseConnect.deviceOS&&"iPad"===CaseConnect.deviceType||"iOS"===CaseConnect.deviceOS&&"iPhone"===CaseConnect.deviceType||CaseConnect.deviceType},1e3),setTimeout(function(){if(null!=e.totalPages&&""!=e.totalPages){var a=0;a=null==t||null==t?0:t;var n=e.totalPages;if(a<n-1){if(0!=$(".loadMsg").length&&$(".loadMsg").remove(),insideEreader){$(".content-top-menu").append('<div class="col-md-5 loadMsg hidden-xs" style="position: relative;top: -15px;left: 25%;font-size: 10pt;font-family: arial;font-weight: bold;color:#c22e3f">We’re loading your notes and highlights . . .</div>'),$("#wk_content .ereader-green-block").after('<div class="col-xs-12 loadMsg visible-xs" style="font-size: 10pt;font-family: arial;font-weight: bold;text-align:center;color:#c22e3f">We’re loading your notes and highlights . . .</div>')}if(insideCasesPage){$(".case-page-content-block #cbc-cases-menu").after('<div class="col-md-5 loadMsg" style="position: absolute;top: 11px;left: 32%;font-size: 10pt;font-family: arial;font-weight: bold;color:#c22e3f">We’re loading your notes and highlights . . .</div>'),$(".case-page-content-block #cases-heading-details").before('<div class="col-xs-12 loadMsg visible-xs" style="font-size: 10pt;font-family: arial;font-weight: bold;text-align:center;margin-top: 10px;color:#c22e3f">We’re loading your notes and highlights . . .</div>')}fetchAnnotations(CaseConnect.currentChapterId,a+1)}a==n-1&&(fetchBrief(CaseConnect.currentChapterId),$(".loadMsg").remove())}else fetchBrief(CaseConnect.currentChapterId)},1e3)}},function(e){sessionAuthFails(e),sessionTimeOut(),0!=$(".loadMsg").length&&$(".loadMsg").remove(),Utility.handleSessionAuthentication(e.responseJSON)?($("#notesSpinner").hide(),$("#previousChapterAnnotationArrow").attr("disabled",!1),$("#nextChapterAnnotationArrow").attr("disabled",!1),$("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain})}function addAnnotationMarkup(e,t){$(e).contents().each(function(){var e=$(this);3==this.nodeType&&MARK&&(multiParaHighlightIndexer++,$(this).wrap(highlightTagFirstPart+multiParaAnnotationID+"_"+multiParaHighlightIndexer+highlightTagLastPart+"</highlight>")),1==this.nodeType&&("highlight"==this.nodeName.toLowerCase()&&($(e).hasClass("highlightedText")&&$(e).attr("id")==t?(MARK=!0,addAnnotationMarkup(e,t)):(MARK=!1,addAnnotationMarkup(e,t))),addAnnotationMarkup(e,t))})}function addAnnotationMarkupByOffestAndLength1(e,t,a){$(e).contents().each(function(){var e=$(this);if(1==this.nodeType)addAnnotationMarkupByOffestAndLength(e,t,a);else if(3==this.nodeType){multiParaHighlightIndexer++;!MARK&&multiParaAnnotationStartParaStartOffset<this.length?(multiParaHighlightIndexer++,$(this).replaceWith(this.textContent.substring(0,multiParaAnnotationStartParaStartOffset)+highlightTagFirstPart+a+"_"+multiParaHighlightIndexer+highlightTagLastPart+this.textContent.substring(multiParaAnnotationStartParaStartOffset,this.length)+"</highlight>"),multiParaAnnotationStartParaEndOffset=multiParaAnnotationStartParaEndOffset-this.length+multiParaAnnotationStartParaStartOffset):MARK&&multiParaAnnotationStartParaEndOffset>this.length?(multiParaHighlightIndexer++,$(this).wrap(highlightTagFirstPart+a+"_"+multiParaHighlightIndexer+highlightTagLastPart+"</highlight>"),multiParaAnnotationStartParaEndOffset-=this.length):MARK&&multiParaAnnotationStartParaEndOffset<this.length?(multiParaHighlightIndexer++,$(this).replaceWith(highlightTagFirstPart+a+"_"+multiParaHighlightIndexer+highlightTagLastPart+this.textContent.substring(0,multiParaAnnotationStartParaEndOffset)+"</highlight>"+this.textContent.substring(multiParaAnnotationStartParaEndOffset,this.length)+"</highlight>"),multiParaAnnotationStartParaStartOffset=-1,multiParaAnnotationStartParaEndOffset=-1):multiParaAnnotationStartParaStartOffset-=this.length}})}function addAnnotationMarkupByOffestAndLength(e,t,a,n){$(e).contents().each(function(){var e=$(this);if(1==this.nodeType)addAnnotationMarkupByOffestAndLength(e,t,a,n);else if(3==this.nodeType){multiParaHighlightIndexer++,(!n||multiParaAnnotationStartParaEndOffset>0)&&(!MARK&&multiParaAnnotationStartParaStartOffset<this.length?(multiParaHighlightIndexer++,$(this).replaceWith(this.textContent.substring(0,multiParaAnnotationStartParaStartOffset)+highlightTagFirstPart+a+"_"+multiParaHighlightIndexer+highlightTagLastPart+this.textContent.substring(multiParaAnnotationStartParaStartOffset,this.length)+"</highlight>"),multiParaAnnotationStartParaEndOffset=multiParaAnnotationStartParaEndOffset-this.length+multiParaAnnotationStartParaStartOffset):MARK&&multiParaAnnotationStartParaEndOffset>this.length?(multiParaHighlightIndexer++,$(this).wrap(highlightTagFirstPart+a+"_"+multiParaHighlightIndexer+highlightTagLastPart+"</highlight>"),multiParaAnnotationStartParaEndOffset-=this.length):MARK&&multiParaAnnotationStartParaEndOffset<this.length?(multiParaHighlightIndexer++,$(this).replaceWith(highlightTagFirstPart+a+"_"+multiParaHighlightIndexer+highlightTagLastPart+this.textContent.substring(0,multiParaAnnotationStartParaEndOffset)+"</highlight>"+this.textContent.substring(multiParaAnnotationStartParaEndOffset,this.length)+"</highlight>"),multiParaAnnotationStartParaStartOffset=-1,multiParaAnnotationStartParaEndOffset=-1):multiParaAnnotationStartParaStartOffset-=this.length)}})}function addAnnotationMarkupByOffestAndLengthForSinglePara(e,t){$(e).contents().each(function(){var e=$(this);1==this.nodeType?addAnnotationMarkupByOffestAndLengthForSinglePara(e,t):3==this.nodeType&&(multiParaHighlightIndexer++,!MARK&&multiParaAnnotationStartParaStartOffset<this.length?(multiParaHighlightIndexer++,$(this).replaceWith(this.textContent.substring(0,multiParaAnnotationStartParaStartOffset)+highlightTagFirstPart+multiParaAnnotationID+"_"+multiParaHighlightIndexer+highlightTagLastPart+this.textContent.substring(multiParaAnnotationStartParaStartOffset,this.length)+"</highlight>"),MARK=!0,multiParaAnnotationStartParaEndOffset=multiParaAnnotationStartParaEndOffset-this.length+multiParaAnnotationStartParaStartOffset):MARK&&multiParaAnnotationStartParaEndOffset>this.length?(multiParaHighlightIndexer++,$(this).wrap(highlightTagFirstPart+multiParaAnnotationID+"_"+multiParaHighlightIndexer+highlightTagLastPart+"</highlight>"),multiParaAnnotationStartParaEndOffset-=this.length):MARK&&multiParaAnnotationStartParaEndOffset<=this.length?(multiParaHighlightIndexer++,this.textContent.substring(0,multiParaAnnotationStartParaEndOffset).length>0&&$(this).replaceWith(highlightTagFirstPart+multiParaAnnotationID+"_"+multiParaHighlightIndexer+highlightTagLastPart+this.textContent.substring(0,multiParaAnnotationStartParaEndOffset)+"</highlight>"+this.textContent.substring(multiParaAnnotationStartParaEndOffset,this.length)+"</highlight>"),multiParaAnnotationStartParaStartOffset=-1,multiParaAnnotationStartParaEndOffset=-1):(multiParaAnnotationStartParaStartOffset-=this.length,multiParaAnnotationStartParaEndOffset-=this.length))})}function addAnnotationMarkup(e,t){$(e).contents().each(function(){var e=$(this);3==this.nodeType&&MARK&&$(this).wrap('<span class="annotation anno-'+t+'"></span>'),1==this.nodeType&&("span"==this.nodeName.toLowerCase()&&($(e).hasClass("anno")&&$(e).attr("id")==t?(MARK=!0,addAnnotationMarkup(e,t)):$(e).attr("id")=="end-"+t&&(MARK=!1,addAnnotationMarkup(e,t))),addAnnotationMarkup(e,t))})}function addNotePopoverHighlight(){$("#"+selectedNoteId).length>0&&$("#"+selectedNoteId).offset().top-topOffset<50&&$(window).height()-$("#"+selectedNoteId).height()-$("#"+selectedNoteId).offset().top<50&&(makingSpaceForpopoverToBeDisplayed=!0,insideEreader&&(document.getElementById("ereader-scroller").scrollTop=document.getElementById(selectedNoteId).offsetTop-50,yValue=document.getElementById(selectedNoteId).getBoundingClientRect().top));if($("#"+selectedNoteId).popover("destroy"),$("#"+selectedNoteId).popover({html:!0,placement:"auto bottom",trigger:"manual",container:"body",template:'<div class="popover ebook-custom-popover" rel=popover id="highlight-popover-notes"><div class="arrow popover-arrow"></div><div class="popover-content note-popover-content popover-without-padding" id="add-note-content-box"></div></div>',content:$("#popover-add-note-content").html()}),$("#"+selectedNoteId).on("shown.bs.popover",function(){var e=$("#highlight-popover-notes").offset().left,t=$(window).width()-($("#highlight-popover-notes").outerWidth()+$("#highlight-popover-notes").offset().left);if(t<0){var a=Math.abs(t);$("#highlight-popover-notes").css("left",e-a+"px")}}),navigator.userAgent.match(/(iPad|Android|iPhone)/)||insideTouchDevices){if(insideEreader&&"true"==CaseConnect.welcomeCaseBriefInEreader&&insidePrincipalCase)return window.getSelection().removeAllRanges(),addingNote=!1,updatingNote=!1,$("#"+selectedNoteId).popover("hide"),void fetchDataForBriefModal();setTimeout(function(){$("#"+selectedNoteId).popover("show"),leftPositionOfPopover=$("#highlight-popover-notes").position().left,$("input#copy").remove(),$("#highlight-buttons-listing button.copy-clipboard-true").remove(),"Professor"!==localStorage.getItem("userRole")||"casebook"!=CaseConnect.bookType&&"coursebook"!=CaseConnect.bookType||($("span#create-link-faculty").css("display","inline-block"),$("span.create-link-faculty").css("width","49%")),"Professor"===localStorage.getItem("userRole")&&"casebook"!==CaseConnect.bookType&&"coursebook"!==CaseConnect.bookType&&($("span#create-link-faculty").css("display","none"),$("span.create-link-faculty").css("width","100%")),"Student"===localStorage.getItem("userRole")&&($("span#create-link-faculty").css("display","none"),$("span.create-link-faculty").css("width","100%")),"undefined"!=typeof insidePrincipalCase&&insidePrincipalCase&&!pCaseWithHeadingCitation?($("span#common-pop-add-note").css("display","none"),$("span#common-pop-add-brief").css("display","inline-block"),$("button#brief-setting-change").css("display","inline-block"),$(".color-btns").css("padding","0 15px")):($("span#common-pop-add-brief").css("display","none"),$("span#common-pop-add-note").css("display","inline-block"),$("button#brief-setting-change").css("display","none"),$(".color-btns").css("padding","0 17px")),loadDataListInPopover()},800)}else{if(insideEreader&&"true"==CaseConnect.welcomeCaseBriefInEreader&&insidePrincipalCase)return window.getSelection().removeAllRanges(),addingNote=!1,updatingNote=!1,$("#"+selectedNoteId).popover("hide"),void fetchDataForBriefModal();if($("#"+selectedNoteId).popover("show"),loadDataListInPopover(),leftPositionOfPopover=$("#highlight-popover-notes").position().left,Clipboard.isSupported()){$("input.zero-clipboard-true").remove();var e=new Clipboard(".copy-clipboard-true",{text:function(){return highlightedTextWithoutHTML}});e.on("success",function(e){}),e.on("error",function(e){})}else $("button.copy-clipboard-true").remove();"Professor"!==localStorage.getItem("userRole")||"casebook"!=CaseConnect.bookType&&"coursebook"!=CaseConnect.bookType||($("span#create-link-faculty").css("display","inline-block"),$("span.create-link-faculty").css("width","33%"),$("input.copy-clipboard-text").css("width","33%")),"Professor"===localStorage.getItem("userRole")&&"casebook"!==CaseConnect.bookType&&"coursebook"!==CaseConnect.bookType&&($("span#create-link-faculty").css("display","none"),$("span.create-link-faculty").css("width","50%"),$("input.copy-clipboard-text").css("width","50%"),$("input.copy-clipboard-text").css("padding","8px 50px 4px")),"Student"===localStorage.getItem("userRole")&&($("span#create-link-faculty").css("display","none"),$("span.create-link-faculty").css("width","50%"),$("input.copy-clipboard-text").css("width","50%"),$("input.copy-clipboard-text").css("padding","8px 50px 4px")),"undefined"!=typeof insidePrincipalCase&&insidePrincipalCase&&!pCaseWithHeadingCitation?($("span#common-pop-add-note").css("display","none"),$("button#brief-setting-change").css("display","inline-block"),$("span#common-pop-add-brief").css("display","inline-block"),$(".color-btns").css("padding","0 15px")):($("span#common-pop-add-brief").css("display","none"),$("span#common-pop-add-note").css("display","inline-block"),$("button#brief-setting-change").css("display","none"),$(".color-btns").css("padding","0 17px")),"true"==CaseConnect.resourceFlag&&$(".resourceMenushow").removeClass("resourceMenuhide"),"true"===CaseConnect.casesFlag?CaseConnect.bookType?"oer"!==CaseConnect.bookType&&$(".hide-case-page-class").show():$(".hide-case-page-class").show():$(".hide-case-page-class").hide(),"true"==CaseConnect.newsFeedFlag&&"true"==CaseConnect.adminNewsFlag?$(".hide-news-feed-class").show():$(".hide-news-feed-class").hide()}displayCommonAnnotationPopover=!0,highlightPalletsVisibleOnly=!0}function confirmDeleteHighlight(){if("Android"==CaseConnect.deviceOS&&(CaseConnect.androidIssueKeypad=!0),keepPopoverVisible=!0,""!=$("textarea#add-note-textarea")[1].innerHTML){if(addingNote)deleteCurrentHighlight();else{var e=$("#popover-confirm-delete-content").clone(!0);$("#add-note-content-box").html(""),$("#add-note-content-box").append(e.html())}updatingNote=!1,addingNote=!1,highlightPalletsVisibleOnly=!1}else""===$("textarea#add-note-textarea")[1].innerHTML&&deleteCurrentHighlight()}function confirmSaveNote(){$("#"+selectedNoteId).popover("destroy"),$("#"+selectedNoteId).popover({html:!0,placement:"auto bottom",trigger:"manual",container:"body",template:'<div class="popover ebook-custom-popover highlight-popover" rel=popover id="note-save-confirmation-wrapper"><div class="popover-content note-popover-content popover-without-padding"></div></div>',content:$("#confirm-added-note-content").html()}),$("#"+selectedNoteId).popover("show");var e=$(window).width(),t=$(".main-container").width(),a=document.body.clientHeight,n=document.body.clientWidth;$(".popover.bottom").css("top",a/2-100),e<768&&e>=t?$(".popover.bottom").css("left",e/2-200):$(".popover.bottom").css("left",n/2-100),ereaderAnnotationDisplayCount=ereaderAnnotationDisplayCount.toString(),saveNoteTimer&&clearTimeout(saveNoteTimer),saveNoteTimer=setTimeout(function(){$("#"+selectedNoteId).popover("hide")},6e3)}function pasteEnableClipboard(){}function pasteDisableClipboard(){}function ereaderEditMessageDisplayStatus(){$("#page-loading-spinner").show();var e={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_GET_USER_SETTINGS",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01"},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}}};$.ajax({url:properties[properties.env]+"/manageUserService/getEreaderAnnotationEditMessageDisplayStatus",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(e)}).then(function(e){$("#page-loading-spinner").hide(),void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),e.userSettingsVO&&"true"===(ereaderAnnotationDisplay=e.userSettingsVO.ereaderAnnotationEditMessageDisplayFlag)&&confirmSaveNote(),sessionTimeOut()},function(e){sessionTimeOut(),sessionAuthFails(e),Utility.handleSessionAuthentication(e.responseJSON)?($("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain})}function saveEreaderMessageDisplayStatus(){var e={userVO:{userId:CaseConnect.currentUserId,userRole:localStorage.getItem("userRole"),userRoleId:localStorage.getItem("userRoleId"),userActivityVO:{lastActivityCode:"EREADER_SAVE_USER_SETTINGS",pageNavigatingFrom:"EReader",pageNavigatingTo:"EReader",lastReadBookId:CaseConnect.currentBookId,lastReadPageNum:CaseConnect.currentPageNumber,lastReadChapterId:CaseConnect.currentChapterId,lastReadSectionId:CaseConnect.currentSectionId,lastReadSubSectionId:"subsec01",lastReadParagraphId:"para01"},sessionVO:{appType:CaseConnect.appType,deviceType:CaseConnect.deviceType,deviceOS:CaseConnect.deviceOS,deviceMacId:CaseConnect.deviceMacId,keepMeLoggedInFlag:CaseConnect.keepMeLoggedInFlag,browserName:CaseConnect.browserName,sessionAuthenticationToken:localStorage.getItem("sessionAuthenticationToken")}},userSettingsVO:{userId:CaseConnect.currentUserId,userRole:CaseConnect.currentUserRole,userRoleId:CaseConnect.currentUserRoleId,ereaderAnnotationEditMessageDisplayFlag:ereaderAnnotationDisplay,ereaderAnnotationEditMessageDisplayCount:1,createdBy:CaseConnect.currentUserId,modifiedBy:CaseConnect.currentUserId}};$.ajax({url:properties[properties.env]+"/manageUserService/saveEreaderAnnotationEditMessageDisplayStatus",type:"POST",contentType:"application/json",accept:"application/json",data:JSON.stringify(e)}).then(function(e){void 0!==e.sessionAuthenticationToken&&localStorage.setItem("sessionAuthenticationToken",e.sessionAuthenticationToken),sessionTimeOut()},function(e){sessionTimeOut(),sessionAuthFails(e),Utility.handleSessionAuthentication(e.responseJSON)?($("#page-loading-spinner").hide(),alertMessagesModal(e.responseJSON.errorMessg)):window.location=properties.ui_domain})}function selectText(e){var t=document,a=t.getElementById(e);if(t.body.createTextRange)(n=t.body.createTextRange()).moveToElementText(a),n.select();else if(window.getSelection){var n,i=window.getSelection();(n=t.createRange()).selectNodeContents(a),acrossParaLevelAnnotationFlag||i.removeAllRanges(),i.addRange(n)}}function repaintSelectedText(e){for(var t=document,a=0;a<e.length;a++){t.createRange();$(e[a]).addClass("ereader-selection-text-color")}}function removeDummyTags(){if(selectedParaIds.length>0)for(var e=0;e<selectedParaIds.length;e++){var t,a;if(selectedNoteId="note"+e,null!==(t=document.getElementById(selectedNoteId)))(a=document.createElement("span")).innerHTML=t.innerHTML,a.normalize(),t.parentNode.replaceChild(a,t)}else selectedNoteId="note"+highLightSpanId,null!==(t=document.getElementById(selectedNoteId))&&((a=document.createElement("span")).innerHTML=t.innerHTML,a.normalize(),t.parentNode.replaceChild(a,t))}function closeit(e){}$(window).on("selectionEnd",function(e){!longTapDetected&&touchEndEventFound&&selectedContent!==window.getSelection().toString()&&highLightSelection(e)}),$(window).on("orientationchange",function(){(insideEreader||insideCasesPage)&&(reCalculateNotesOnRight(),reCalculateBriefOnRight(),reCalculateLinkOnLeft(),reCalculateRtSOnLeft(),window.orientation)}),$(document).on("click touchstart",function(e){if(insideEreader||insideCasesPage){if(!($(e.target).parent(".ccapp-localtoc-entry").length>0)&&"A"!==$(e.target).prop("tagName")&&"Android"===CaseConnect.deviceOS&&"click"===e.type)return e.stopPropagation(),!1;customBriefModified&&"undefined"!=typeof elem&&saveCustomBrief(elem,event),$("ul#searchAutoSuggestList").length>1&&($("ul#searchAutoSuggestList")[1].style.display="none"),$("ul#searchAutoSuggestListCase").length>1&&($("ul#searchAutoSuggestListCase")[0].style.display="none"),$("ul.searchAutoSuggestListCase").length>1&&$("ul.searchAutoSuggestListCase").css("display","none"),$("ul#searchAutoSuggestListCaseMobile").length>1&&$("ul#searchAutoSuggestListCaseMobile").css("display","none"),saveNoteTimer&&clearTimeout(saveNoteTimer),$(".connections-logo").click(function(){$("#header-wrapper").css("display","block")}),$(".popover-search-field").keyup(function(){var e=$(".popover-search-field")[1].value;""!=e?($(".ereader-text-search-cancel").show()[1],$(".popover-search-field").removeClass("search-field-background")):""===e&&closeSearchText()})[2],noteTextClick?(noteTextClick=!1,"note0"===selectedNoteId&&removeDummyTags()):$("#"+selectedNoteId).each(function(){if(!$(this).is(e.target)&&0===$(this).has(e.target).length&&0===$(".popover").has(e.target).length){var t=e.target;if(null!==t)for(;!t.classList.contains("cc-marker");){if(t.hasAttributes("data-references")){t=t;break}t=t.parentElement}if(null===t||-1==t.id.indexOf("_")||t.id.substring(0,t.id.indexOf("_"))!=$(this).attr("id")){var a;if(removeDefaultSelectionColor(),addingNote)if(0===selectedNoteId.indexOf("note"))if(""===$("textarea#add-note-textarea")[1].value){addingNote=!1,updatingNote=!1,displayCommonAnnotationPopover=!1,$("#"+selectedNoteId).popover("hide"),highlightPopoverVisible=!1;for(var n=$('highlight[id^="note"]'),i=0;i<n.length;i++){var o=document.getElementById(n[i].id);(r=document.createElement("span")).innerHTML=o.innerHTML,r.normalize(),o.parentNode.replaceChild(r,o)}}else checkSaveHighlight=!0,saveHighlights();else if($("textarea#add-note-textarea").length>1)"span"!==(a=e.target).tagName.toLowerCase()&&"i"!==a.tagName.toLowerCase()&&"b"!==a.tagName.toLowerCase()&&(""===$("textarea#add-note-textarea")[1].value?(addingNote=!1,keepPopoverVisible?"span"!==a.tagName.toLowerCase()&&(keepPopoverVisible=!1):$("#"+selectedNoteId).popover("hide"),"span"!==a.tagName.toLowerCase()&&(highlightPopoverVisible=!1)):($("#page-loading-spinner").show(),checkSaveNote=!0,addNotes()));else closePopover();else updatingNote?$("textarea#add-note-textarea").length>1?""===$("textarea#add-note-textarea")[1].value?(updatingNote=!1,deleteNotes()):"visible"===$(".save-note-icon").css("visibility")?updateNotes():updateHighlightCalledFromPallets||($("#"+selectedNoteId).popover("hide"),updatingNote=!1,alreadyCalled=!1):closePopover():displayCommonAnnotationPopover?($("#"+selectedNoteId).popover("hide"),removeDummyTags(),displayCommonAnnotationPopover=!1,pCaseWithHeadingCitation=!1,pCaseWithHeadingOnly=!1):highlightPalletsVisibleOnly&&($("#"+selectedNoteId).popover("hide"),highlightPalletsVisibleOnly=!1);if(addingLink)if(0===selectedNoteId.indexOf("note"))""===$("input#add-link-url")[1].value?(addingLink=!1,updatingLink=!1,displayCommonAnnotationPopover=!1,pCaseWithHeadingCitation=!1,pCaseWithHeadingOnly=!1,$("#"+selectedNoteId).popover("hide"),removeDummyTags()):saveCreatedLink();else if($("input#add-link-url").length>1)if(""===$("input#add-link-url")[1].value)if(addingLink=!1,keepPopoverVisible)keepPopoverVisible=!1;else{$("#"+selectedNoteId).popover("hide");for(n=$('highlight[id^="note"]'),i=0;i<n.length;i++){o=document.getElementById(n[i].id);(r=document.createElement("span")).innerHTML=o.innerHTML,r.normalize(),o.parentNode.replaceChild(r,o)}}else $("#page-loading-spinner").show(),saveCreatedLink();else closePopover();else updatingLink&&($("input#add-link-url").length>1?""===$("input#add-link-url")[1].value?(updatingLink=!1,deleteLink()):updateLink():closePopover());if(addingBrief)if(0===selectedNoteId.indexOf("note"))void 0===$("input#add-brief-label-box")[1]||""!==$("input#add-brief-label-box")[1].value||void 0==="textarea#add-brief-textarea"[1]||""!==$("textarea#add-brief-textarea")[1].value||$(".color-btns").hasClass("selectedColor")?(checkSaveBrief=!0,addBrief()):(addingBrief=!1,updatingBrief=!1,displayCommonAnnotationPopover=!1,$("#"+selectedNoteId).popover("hide"),addBriefPopoverShown=!1,clickedInsidePcaseForAnnot=!1,removeDummyTags());else if($("input#add-brief-label-box").length>1||$("textarea#add-brief-textarea").length>1){if("span"!==(a=e.target).tagName.toLowerCase()&&"i"!==a.tagName.toLowerCase()&&"b"!==a.tagName.toLowerCase())if(""!==$("input#add-brief-label-box")[1].value||""!==$("textarea#add-brief-textarea")[1].value||$(".color-btns").hasClass("selectedColor"))$("#page-loading-spinner").show(),checkSaveBrief=!0,addBrief();else{if(addingBrief=!1,keepBriefPopoverVisible)"span"!==a.tagName.toLowerCase()&&(keepBriefPopoverVisible=!1);else{$("#"+selectedNoteId).popover("hide");for(n=$('highlight[id^="note"]'),i=0;i<n.length;i++){var r;o=document.getElementById(n[i].id);(r=document.createElement("span")).innerHTML=o.innerHTML,r.normalize(),o.parentNode.replaceChild(r,o)}}"span"!==a.tagName.toLowerCase()&&(addBriefPopoverShown=!1),clickedInsidePcaseForAnnot=!1}}else closePopover();else updatingBrief&&!addedBriefFromAnnotation?$("input#add-brief-label-box").length>1||$("textarea#add-brief-textarea").length>1?""!==$("input#add-brief-label-box")[1].value||""!==$("textarea#add-brief-textarea")[1].value||$(".color-btns").hasClass("selectedColor")?(""!==$("input#add-brief-label-box")[1].value||""===$("textarea#add-brief-textarea")[1].value||$(".color-btns").hasClass("selectedColor"))&&updateBrief():(updatingBrief=!1,$("#"+selectedNoteId).popover("hide")):closePopover():addedBriefFromAnnotation?migrateChapterHighlightsSingle():(keepPopoverVisible||addingNote||updatingNote||addingLink||updatingLink||addingBrief||updatingBrief||keepBriefPopoverVisible?(keepPopoverVisible=!1,keepBriefPopoverVisible=!1):$("#"+selectedNoteId).popover("hide"),highlightPopoverVisible=!1,addBriefPopoverShown=!1,addedBriefFromAnnotation=!1);displayCommonAnnotationPopover&&($("#"+selectedNoteId).popover("hide"),removeDummyTags(),displayCommonAnnotationPopover=!1,pCaseWithHeadingCitation=!1,pCaseWithHeadingOnly=!1)}}}),$("#ebook-toc").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||(notesAndHighlightListVisible?insideTouchDevices||(notesAndHighlightListVisible=!1):($("#ebook-toc").popover("hide"),loadingAnnotationsFromTOC=!0))}),$("#ebook-toc-mobile").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||($("#ebook-toc-mobile").popover("hide"),loadingAnnotationsFromTOC=!0)}),$('[data-toggle="popover"]').each(function(){var t=e.target;if(insideEreader&&(highLightedTextClickFlag||briefTextClickFlag)&&("HIGHLIGHT"!==e.target.tagName||"highlight"!==e.target.tagName)){var a=e.target;if(null!==a)for(;!a.classList.contains("cc-marker");){if(a.hasAttributes("data-references")){t=a=a;break}a=a.parentElement}}$(this).is(t)||0!==$(this).has(t).length||0!==$(".popover").has(t).length||$(this).hasClass("highlightedText")||$(t).hasClass("highlightedText")||"ebook-toc"===this.id||"ebook-toc-mobile"===this.id||$(this).hasClass("rTsIconPopover")||$(this).hasClass("briefElementText")||$(t).hasClass("briefElementText")?$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(this).hasClass("highlightedText")||$(e.target).hasClass("highlightedText")||"ebook-toc"===this.id||"ebook-toc-mobile"===this.id||!$(this).hasClass("rTsIconPopover")||$(this).hasClass("case-search-area")||$(e.target).hasClass("case-search-area")||($(this).popover("hide"),$(this).hasClass("rTsIconPopover")||hideDocumentPopover(),!$("#read-study-lo-popover").is(":visible")&&$("#read-study-notify").is(":visible")&&insideEreader&&$(document).popover("hide")):(addingNote||updatingNote||addingLink||updatingLink||addingBrief||updatingBrief||($(this).popover("hide"),!$("#read-study-lo-popover").is(":visible")&&$("#read-study-notify").is(":visible")&&insideEreader&&$(document).popover("hide"),$(".popover-search-field").val(searchedTextSaved),searchResultListVisible&&(searchResultListVisible=!1,$(".cancel-search").show())),highlightPopoverVisible&&addingNote&&(highlightPopoverVisible=!1,addingNote=!1),addBriefPopoverShown&&addingBrief&&(addBriefPopoverShown=!1,addingBrief=!1),$(".ereader-chapter-list").next("div.popover:visible").length?$(".ereader-chapter-list").find(".toggle-up-down").addClass("glyphicon-menu-up").removeClass("glyphicon-menu-down"):$(".ereader-chapter-list").find(".toggle-up-down").addClass("glyphicon-menu-down").removeClass("glyphicon-menu-up")),$(".case-search-area").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(".popover-case-search-field").val(savedCaseSearchedText)})})}else insideOutline&&($(".popover-search-field").val(""),$("#outline-menu").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$("#outline-menu").popover("hide")}),$("button#outline-search-text-desktop").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||($(".popover-outline-search-field").val(savedOutlineSearchedText),void 0!==$("input#outline-search-text")[1]&&($("input#outline-search-text")[1].value=savedOutlineSearchedText),void 0!==$("input#outline-search-text")[0]&&($("input#outline-search-text")[0].value=savedOutlineSearchedText),$("#outline-search-text-desktop").popover("hide"))}),$("#outline-search-mobile").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||($(".popover-outline-search-field").val(savedOutlineSearchedText),void 0!==$("input#outline-search-text")[1]&&($("input#outline-search-text")[1].value=savedOutlineSearchedText),$("#outline-search-mobile").popover("hide"))}));$("#class-code-info-button-faculty").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$("#class-code-info-button-faculty").popover("hide")}),$("#endorse-ques-info-button-faculty").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$("#endorse-ques-info-button-faculty").popover("hide")}),$("#endorse-ques-info-button-student").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$("#endorse-ques-info-button-student").popover("hide")})}),$("ul.dropdown-menu li:last-child").focusout(function(){$('[data-toggle="dropdown"]').parent().removeClass("open")});